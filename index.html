
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Like的世界</title>
  <meta name="author" content="Like Ma">

  
  <meta name="description" content="std::forward_list 为 C++ 11 STL 的 单向 链表: 仅记录了首指针，未记录尾指针和链表长度，即无 push_back 和 size 方法。
相比 std::list （双向链表，以下简化为 list） 节约内存空间
仅能 顺序访问 ，无法 倒序访问 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.malike.net.cn">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Like的世界" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44993010-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Like的世界</a></h1>
  
    <h2>个人总结与随想</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.malike.net.cn" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories">Categories</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/12/03/std-forward-list-tutorial/">Std::forward_list 简介</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2021-12-03T23:35:46+00:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2021/12/03/std-forward-list-tutorial/#disqus_thread"
             data-disqus-identifier="http://www.malike.net.cn/blog/2021/12/03/std-forward-list-tutorial/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://en.cppreference.com/w/cpp/container/forward_list"><code>std::forward_list</code></a> 为 C++ 11 STL 的 <strong>单向</strong> 链表:</p>

<ul>
<li>仅记录了首指针，未记录尾指针和链表长度，即无 <code>push_back</code> 和 <code>size</code> 方法。</li>
<li>相比 <a href="https://en.cppreference.com/w/cpp/container/list"><code>std::list</code></a> （双向链表，以下简化为 <code>list</code>）

<ul>
<li>节约内存空间</li>
<li>仅能 <strong>顺序访问</strong> ，无法 <strong>倒序访问</strong></li>
<li><code>forward_list::sort</code> 时间复杂度 <strong>O(n log n)</strong> ，但效率不如 <code>list::sort</code> ，尤其链表包含大量元素时。</li>
</ul>
</li>
</ul>


<p>因 <code>forward_list</code> 与 <code>list</code> 大部分方法相同，这里仅介绍 <code>forward_list</code> 不具备的能力。</p>

<h2>顺序插入</h2>

<p>因无 <code>forward_list::push_back</code> 方法，顺序插入 <code>forward_list</code> 一组元素得依靠调用者 <strong>自行</strong> 保存尾指针。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">forward_list</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">fl</span><span class="p">;</span>
</span><span class='line'><span class="k">auto</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">fl</span><span class="p">.</span><span class="n">before_begin</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">iter</span> <span class="o">=</span> <span class="n">fl</span><span class="p">.</span><span class="n">insert_after</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="https://en.cppreference.com/w/cpp/container/forward_list/before_begin"><code>before_begin</code></a> 返回首元素之前的元素（placeholder）。该元素实际不存在，访问它将导致未定义行为。</p>

<h2>顺序复制</h2>

<ul>
<li><code>back_inserter</code> 返回的 <code>std::back_insert_iterator</code> 要求容器实现了 <code>push_back</code> 方法。</li>
<li><code>inserter</code> 返回的 <code>std::insert_iterator</code> 要求容器实现了 <code>insert</code> 方法。</li>
</ul>


<p>显然，两者皆不适用于 <code>forward_list</code> ，然 <code>inserter</code> 最接近：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">forward_list</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">fl</span><span class="p">;</span>
</span><span class='line'><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">v</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">inserter</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">fl</span><span class="p">.</span><span class="n">before_begin</span><span class="p">()));</span>
</span></code></pre></td></tr></table></div></figure>


<p>为使上述代码能被编译和运行，须偏特化 <code>std::insert_iterator</code> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">namespace</span> <span class="n">std</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">insert_iterator</span><span class="o">&lt;</span><span class="n">forward_list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;:</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">iterator</span><span class="o">&lt;</span><span class="n">output_iterator_tag</span><span class="p">,</span> <span class="kt">void</span><span class="p">,</span> <span class="kt">void</span><span class="p">,</span> <span class="kt">void</span><span class="p">,</span> <span class="kt">void</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="n">forward_list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">container_type</span><span class="p">;</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="k">typename</span> <span class="n">container_type</span><span class="o">::</span><span class="n">iterator</span> <span class="n">iterator_type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">insert_iterator</span><span class="p">(</span><span class="n">container_type</span><span class="o">&amp;</span> <span class="n">c</span><span class="p">,</span> <span class="n">iterator_type</span> <span class="n">i</span><span class="p">)</span><span class="o">:</span>
</span><span class='line'>        <span class="n">container_</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">iter_</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">insert_iterator</span><span class="o">&amp;</span> <span class="k">operator</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">typename</span> <span class="n">container_type</span><span class="o">::</span><span class="n">value_type</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">iter_</span> <span class="o">=</span> <span class="n">container_</span><span class="p">.</span><span class="n">insert_after</span><span class="p">(</span><span class="n">iter_</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">insert_iterator</span><span class="o">&amp;</span> <span class="k">operator</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">typename</span> <span class="n">container_type</span><span class="o">::</span><span class="n">value_type</span><span class="o">&amp;&amp;</span> <span class="n">v</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">iter_</span> <span class="o">=</span> <span class="n">container_</span><span class="p">.</span><span class="n">insert_after</span><span class="p">(</span><span class="n">iter_</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">v</span><span class="p">));</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">insert_iterator</span><span class="o">&amp;</span> <span class="k">operator</span> <span class="o">*</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">insert_iterator</span><span class="o">&amp;</span> <span class="k">operator</span> <span class="o">++</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">insert_iterator</span><span class="o">&amp;</span> <span class="k">operator</span> <span class="o">++</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>    <span class="n">container_type</span><span class="o">&amp;</span> <span class="n">container_</span><span class="p">;</span>
</span><span class='line'>    <span class="n">iterator_type</span> <span class="n">iter_</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span> <span class="c1">// namespace std</span>
</span></code></pre></td></tr></table></div></figure>


<p>此法不支持让用户定义 <code>forward_list</code> 的 allocator 。</p>

<p>完美办法为重新实现 <code>forward_list_insert_iterator</code> 和 <code>forward_list_inserter</code> 。</p>

<h2>求长度</h2>

<p>因 <code>forward_list</code> 未保存长度——无 <code>size</code> 方法，故须 <strong>O(n)</strong> 时间复杂度的 <code>std::distance</code> 计算长度：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">forward_list</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">fl</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">};</span>
</span><span class='line'><span class="k">auto</span> <span class="n">size</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">distance</span><span class="p">(</span><span class="n">fl</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">fl</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
</span></code></pre></td></tr></table></div></figure>


<p>而 <code>forward_list::empty</code> （长度是否为 <code>0</code> ）的时间复杂度 <strong>O(1)</strong></p>

<p>值得一提 <a href="https://www.boost.org/doc/libs/1_77_0/doc/html/boost/container/slist.html"><code>boost::slist</code></a> 高度相似于 <code>forward_list</code> ，但前者保存长度，即 <code>boost::slist::size</code> 方法时间复杂度 <strong>O(1)</strong></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/08/15/modify-elf-by-lief/">通过 LIEF 修改 ELF 解决 Glibc 兼容性问题</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2021-08-15T21:25:15+00:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2021/08/15/modify-elf-by-lief/#disqus_thread"
             data-disqus-identifier="http://www.malike.net.cn/blog/2021/08/15/modify-elf-by-lief/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>数月前，我读了 <a href="https://mp.weixin.qq.com/s/2NNqYGYcCo2TEX4yfqG0qQ">Linux 修改 ELF 解决 glibc 兼容性问题</a> ，颇受启发，但暂无用武之地。</p>

<p>最近，我遇到了几乎一样的问题，即 <code>clock_gettime</code> 兼容性。</p>

<h2>最小化问题</h2>

<p>为了将问题最小化，这里我以 <code>hello.c</code> 模拟该问题：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;time.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts</span><span class="p">;</span>
</span><span class='line'>    <span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_REALTIME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%lu, %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ts</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="n">ts</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在 Ubuntu 20.04 中，用系统内置 GCC 9.3.0 构建它：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gcc -fno-stack-protector -o hello hello.c -s
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>-fno-stack-protector</code> : 禁用 stack 保护特性。目的为最小化未定义符号，最小化问题场景。</li>
<li><code>-s</code> : 除去调试相关符号，目的同上。</li>
</ul>


<p>通过 <code>readelf -sV hello</code> 展示其符号：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Symbol table <span class="s1">&#39;.dynsym&#39;</span> contains <span class="m">8</span> entries:
</span><span class='line'>   Num:    Value          Size Type    Bind   Vis      Ndx Name
</span><span class='line'>     .....
</span><span class='line'>     2: <span class="m">0000000000000000</span>     <span class="m">0</span> FUNC    GLOBAL DEFAULT  UND clock_gettime@GLIBC_2.17 <span class="o">(</span>2<span class="o">)</span>
</span><span class='line'>     3: <span class="m">0000000000000000</span>     <span class="m">0</span> FUNC    GLOBAL DEFAULT  UND <span class="nb">printf</span>@GLIBC_2.2.5 <span class="o">(</span>3<span class="o">)</span>
</span><span class='line'>     ......
</span><span class='line'>
</span><span class='line'>Version symbols section <span class="s1">&#39;.gnu.version&#39;</span> contains <span class="m">8</span> entries:
</span><span class='line'> Addr: 0x0000000000000526  Offset: 0x000526  Link: <span class="m">6</span> <span class="o">(</span>.dynsym<span class="o">)</span>
</span><span class='line'>  000:   <span class="m">0</span> <span class="o">(</span>*local*<span class="o">)</span>       <span class="m">0</span> <span class="o">(</span>*local*<span class="o">)</span>       <span class="m">2</span> <span class="o">(</span>GLIBC_2.17<span class="o">)</span>    <span class="m">3</span> <span class="o">(</span>GLIBC_2.2.5<span class="o">)</span>
</span><span class='line'>  ......
</span><span class='line'>
</span><span class='line'>Version needs section <span class="s1">&#39;.gnu.version_r&#39;</span> contains <span class="m">1</span> entry:
</span><span class='line'> Addr: 0x0000000000000538  Offset: 0x000538  Link: <span class="m">7</span> <span class="o">(</span>.dynstr<span class="o">)</span>
</span><span class='line'>  000000: Version: <span class="m">1</span>  File: libc.so.6  Cnt: 2
</span><span class='line'>  0x0010:   Name: GLIBC_2.2.5  Flags: none  Version: 3
</span><span class='line'>  0x0020:   Name: GLIBC_2.17  Flags: none  Version: 2
</span></code></pre></td></tr></table></div></figure>


<p>问题在于修改 <code>.gnu.version_r</code> 段偏移 <code>0x0020</code> 的相关值。回顾 <code>Elfxx_Vernaux</code> 结构：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Elfxx_Word</span>    <span class="n">vna_hash</span><span class="p">;</span>  <span class="c1">// 库名称 (如 GLIBC_2.17) 的 hash 值</span>
</span><span class='line'>    <span class="n">Elfxx_Half</span>    <span class="n">vna_flags</span><span class="p">;</span>
</span><span class='line'>    <span class="n">Elfxx_Half</span>    <span class="n">vna_other</span><span class="p">;</span> <span class="c1">// .gnu.version 段中符号的版本值</span>
</span><span class='line'>    <span class="n">Elfxx_Word</span>    <span class="n">vna_name</span><span class="p">;</span>  <span class="c1">// 库名称 (如 GLIBC_2.17) 为相对 .dynstr 段偏移</span>
</span><span class='line'>    <span class="n">Elfxx_Word</span>    <span class="n">vna_next</span><span class="p">;</span>  <span class="c1">// 下一条记录相对本记录首地址的偏移</span>
</span><span class='line'><span class="p">}</span> <span class="n">Elfxx_Vernaux</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>实际仅须修改 <code>vna_hash</code> 和 <code>vna_name</code> ，前者实为后者的校验和。</p>

<p>以下提供 2 种方法修改 <code>hello</code> 二进制文件，使其无须重编译就能运行于 RHEL/CentOS 6 中。</p>

<h2>通过 dd 修改</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># 复制 hello 偏移 0x538 + 0x10 = 0x548 的 4 byte 至文件 glibc225_vna_hash ；</span>
</span><span class='line'>dd <span class="k">if</span><span class="o">=</span>hello <span class="nv">of</span><span class="o">=</span>glibc225_vna_hash <span class="nv">skip</span><span class="o">=</span><span class="k">$((</span><span class="m">16#548</span><span class="k">))</span> <span class="nv">bs</span><span class="o">=</span><span class="m">1</span> <span class="nv">count</span><span class="o">=</span>4
</span><span class='line'>
</span><span class='line'><span class="c"># 复制 hello 偏移 0x538 + 0x10 + 0x08 = 0x550 的 4 byte 至文件 glibc225_vna_hash</span>
</span><span class='line'>dd <span class="k">if</span><span class="o">=</span>hello <span class="nv">of</span><span class="o">=</span>glibc225_vna_name <span class="nv">skip</span><span class="o">=</span><span class="k">$((</span><span class="m">16#550</span><span class="k">))</span> <span class="nv">bs</span><span class="o">=</span><span class="m">1</span> <span class="nv">count</span><span class="o">=</span>4
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>0x538</code> 为 <code>.gnu.version_r</code> 段首地址。</li>
<li><code>0x10</code> 为 <code>GLIBC_2.2.5</code> 记录的段偏移，即 <code>Elfxx_Vernaux::vna_hash</code> 偏移。</li>
<li><code>0x08</code> 为 <code>GLIBC_2.2.5</code> 记录内 <code>Elfxx_Vernaux::vna_name</code> 偏移。</li>
</ul>


<p>为保持 <code>hello</code> 不改变， 修改 <code>hello</code> 至 <code>hello-dd</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cp hello hello-dd
</span><span class='line'>
</span><span class='line'><span class="c"># 复制 glibc225_vna_hash 至 hello-dd 偏移 0x530 + 0x20 = 0x558</span>
</span><span class='line'>dd <span class="k">if</span><span class="o">=</span>glibc225_vna_hash <span class="nv">of</span><span class="o">=</span>hello-dd <span class="nv">seek</span><span class="o">=</span><span class="k">$((</span><span class="m">16#558</span><span class="k">))</span> <span class="nv">bs</span><span class="o">=</span><span class="m">1</span> <span class="nv">conv</span><span class="o">=</span>notrunc
</span><span class='line'>
</span><span class='line'><span class="c"># 复制 glibc225_vna_name 至 hello-dd 偏移 0x530 + 0x20 + 0x08 = 0x560</span>
</span><span class='line'>dd <span class="k">if</span><span class="o">=</span>glibc225_vna_name <span class="nv">of</span><span class="o">=</span>hello-dd <span class="nv">seek</span><span class="o">=</span><span class="k">$((</span><span class="m">16#560</span><span class="k">))</span> <span class="nv">bs</span><span class="o">=</span><span class="m">1</span> <span class="nv">conv</span><span class="o">=</span>notrunc
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>0x20</code> 为 <code>GLIBC_2.1.7</code> 记录的段偏移，即 <code>Elfxx_Vernaux::vna_hash</code> 偏移。</li>
<li><code>0x08</code> 为 <code>GLIBC_2.1.7</code> 记录内 <code>Elfxx_Vernaux::vna_name</code> 偏移。</li>
</ul>


<p>通过 <code>readelf -sV hello</code> 观察修改是否生效：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Symbol table <span class="s1">&#39;.dynsym&#39;</span> contains <span class="m">8</span> entries:
</span><span class='line'>   Num:    Value          Size Type    Bind   Vis      Ndx Name
</span><span class='line'>     ......
</span><span class='line'>     2: <span class="m">0000000000000000</span>     <span class="m">0</span> FUNC    GLOBAL DEFAULT  UND clock_gettime@GLIBC_2.2.5 <span class="o">(</span>2<span class="o">)</span>
</span><span class='line'>     3: <span class="m">0000000000000000</span>     <span class="m">0</span> FUNC    GLOBAL DEFAULT  UND <span class="nb">printf</span>@GLIBC_2.2.5 <span class="o">(</span>3<span class="o">)</span>
</span><span class='line'>     ......
</span><span class='line'>
</span><span class='line'>Version symbols section <span class="s1">&#39;.gnu.version&#39;</span> contains <span class="m">8</span> entries:
</span><span class='line'> Addr: 0x0000000000000526  Offset: 0x000526  Link: <span class="m">4</span> <span class="o">(</span>.dynsym<span class="o">)</span>
</span><span class='line'>  000:   <span class="m">0</span> <span class="o">(</span>*local*<span class="o">)</span>       <span class="m">0</span> <span class="o">(</span>*local*<span class="o">)</span>       <span class="m">2</span> <span class="o">(</span>GLIBC_2.2.5<span class="o">)</span>   <span class="m">3</span> <span class="o">(</span>GLIBC_2.2.5<span class="o">)</span>
</span><span class='line'>  ......
</span><span class='line'>
</span><span class='line'>Version needs section <span class="s1">&#39;.gnu.version_r&#39;</span> contains <span class="m">1</span> entry:
</span><span class='line'> Addr: 0x0000000000000538  Offset: 0x000538  Link: <span class="m">26</span> <span class="o">(</span>.dynstr<span class="o">)</span>
</span><span class='line'>  000000: Version: <span class="m">1</span>  File: libc.so.6  Cnt: 2
</span><span class='line'>  0x0010:   Name: GLIBC_2.2.5  Flags: none  Version: 3
</span><span class='line'>  0x0020:   Name: GLIBC_2.2.5  Flags: none  Version: 2
</span></code></pre></td></tr></table></div></figure>


<p>最后，将 <code>librt.so.1</code> 添加至 <code>hello-dd</code> 的库依赖列表中。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>patchelf --add-needed librt.so.1 hello-dd
</span></code></pre></td></tr></table></div></figure>


<h2>通过 LIEF</h2>

<p><a href="https://lief.quarkslab.com/doc/latest/intro.html">LIEF</a> 是一个能分析和修改 ELF , PE , MachO 和 Android 格式的库，它提供了 C/C++ 和 Python 的 API.</p>

<p>以下通过 LIEF 的 Python API 达到上述同样的效果。</p>

<h3>安装</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>pip3 install lief
</span></code></pre></td></tr></table></div></figure>


<h3>写脚本</h3>

<p>创建 <code>lief-hello.py</code> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">lief</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">binary</span> <span class="o">=</span> <span class="n">lief</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">&#39;hello&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">glibc225_aux</span> <span class="o">=</span> <span class="n">clock_gettime_aux</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">binary</span><span class="o">.</span><span class="n">imported_symbols</span><span class="p">:</span>
</span><span class='line'>    <span class="c"># 查找 GLIBC_2.2.5 的 symbol_version_auxiliary 记录，</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">symbol_version</span><span class="o">.</span><span class="n">symbol_version_auxiliary</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;GLIBC_2.2.5&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">glibc225_aux</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">symbol_version</span><span class="o">.</span><span class="n">symbol_version_auxiliary</span>
</span><span class='line'>    <span class="c"># 查找 clock_gettime 的 symbol_version_auxiliary 记录，</span>
</span><span class='line'>    <span class="k">elif</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;clock_gettime&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">clock_gettime_aux</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">symbol_version</span><span class="o">.</span><span class="n">symbol_version_auxiliary</span>
</span><span class='line'>
</span><span class='line'><span class="c"># 复制 GLIBC_2.2.5 记录 name 和 hash 至 clock_gettime 记录对应字段中。</span>
</span><span class='line'><span class="k">if</span> <span class="n">glibc225_aux</span> <span class="ow">and</span> <span class="n">clock_gettime_aux</span><span class="p">:</span>
</span><span class='line'>    <span class="n">clock_gettime_aux</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">glibc225_aux</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>    <span class="n">clock_gettime_aux</span><span class="o">.</span><span class="n">hash</span> <span class="o">=</span> <span class="n">glibc225_aux</span><span class="o">.</span><span class="n">hash</span>
</span><span class='line'>    <span class="n">binary</span><span class="o">.</span><span class="n">add_library</span><span class="p">(</span><span class="s">&#39;librt.so.1&#39;</span><span class="p">)</span>  <span class="c"># 相当于 patchelf --add-needed librt.so.1</span>
</span><span class='line'>    <span class="n">binary</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;hello-lief&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>以上 <code>symbol_version_auxiliary</code> 相当于前述 <code>Elfxx_Vernaux</code></p>

<h3>执行脚本</h3>

<p>执行 <code>python3 lief-hello.py</code> 将生成 <code>hello-lief</code> 。</p>

<p>通过 <code>readelf -sV hello-lief</code> 观察修改是否生效：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">Symbol</span> <span class="n">table</span> <span class="s">&#39;.dynsym&#39;</span> <span class="n">contains</span> <span class="mi">8</span> <span class="n">entries</span><span class="p">:</span>
</span><span class='line'>   <span class="n">Num</span><span class="p">:</span>    <span class="n">Value</span>          <span class="n">Size</span> <span class="n">Type</span>    <span class="n">Bind</span>   <span class="n">Vis</span>      <span class="n">Ndx</span> <span class="n">Name</span>
</span><span class='line'>     <span class="o">......</span>
</span><span class='line'>     <span class="mi">2</span><span class="p">:</span> <span class="mo">0000000000000000</span>     <span class="mi">0</span> <span class="n">FUNC</span>    <span class="n">GLOBAL</span> <span class="n">DEFAULT</span>  <span class="n">UND</span> <span class="n">clock_gettime</span><span class="nd">@GLIBC_2.2.5</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>     <span class="mi">3</span><span class="p">:</span> <span class="mo">0000000000000000</span>     <span class="mi">0</span> <span class="n">FUNC</span>    <span class="n">GLOBAL</span> <span class="n">DEFAULT</span>  <span class="n">UND</span> <span class="n">printf</span><span class="nd">@GLIBC_2.2.5</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>     <span class="o">......</span>
</span><span class='line'>
</span><span class='line'><span class="n">Version</span> <span class="n">symbols</span> <span class="n">section</span> <span class="s">&#39;.gnu.version&#39;</span> <span class="n">contains</span> <span class="mi">8</span> <span class="n">entries</span><span class="p">:</span>
</span><span class='line'> <span class="n">Addr</span><span class="p">:</span> <span class="mh">0x0000000000002526</span>  <span class="n">Offset</span><span class="p">:</span> <span class="mh">0x002526</span>  <span class="n">Link</span><span class="p">:</span> <span class="mi">6</span> <span class="p">(</span><span class="o">.</span><span class="n">dynsym</span><span class="p">)</span>
</span><span class='line'>  <span class="mo">000</span><span class="p">:</span>   <span class="mi">0</span> <span class="p">(</span><span class="o">*</span><span class="n">local</span><span class="o">*</span><span class="p">)</span>       <span class="mi">0</span> <span class="p">(</span><span class="o">*</span><span class="n">local</span><span class="o">*</span><span class="p">)</span>       <span class="mi">2</span> <span class="p">(</span><span class="n">GLIBC_2</span><span class="o">.</span><span class="mf">2.5</span><span class="p">)</span>   <span class="mi">3</span> <span class="p">(</span><span class="n">GLIBC_2</span><span class="o">.</span><span class="mf">2.5</span><span class="p">)</span>
</span><span class='line'>  <span class="o">......</span>
</span><span class='line'>
</span><span class='line'><span class="n">Version</span> <span class="n">needs</span> <span class="n">section</span> <span class="s">&#39;.gnu.version_r&#39;</span> <span class="n">contains</span> <span class="mi">1</span> <span class="n">entry</span><span class="p">:</span>
</span><span class='line'> <span class="n">Addr</span><span class="p">:</span> <span class="mh">0x0000000000002538</span>  <span class="n">Offset</span><span class="p">:</span> <span class="mh">0x002538</span>  <span class="n">Link</span><span class="p">:</span> <span class="mi">7</span> <span class="p">(</span><span class="o">.</span><span class="n">dynstr</span><span class="p">)</span>
</span><span class='line'>  <span class="mo">000000</span><span class="p">:</span> <span class="n">Version</span><span class="p">:</span> <span class="mi">1</span>  <span class="n">File</span><span class="p">:</span> <span class="n">libc</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mi">6</span>  <span class="n">Cnt</span><span class="p">:</span> <span class="mi">2</span>
</span><span class='line'>  <span class="mh">0x0010</span><span class="p">:</span>   <span class="n">Name</span><span class="p">:</span> <span class="n">GLIBC_2</span><span class="o">.</span><span class="mf">2.5</span>  <span class="n">Flags</span><span class="p">:</span> <span class="n">none</span>  <span class="n">Version</span><span class="p">:</span> <span class="mi">3</span>
</span><span class='line'>  <span class="mh">0x0020</span><span class="p">:</span>   <span class="n">Name</span><span class="p">:</span> <span class="n">GLIBC_2</span><span class="o">.</span><span class="mf">2.5</span>  <span class="n">Flags</span><span class="p">:</span> <span class="n">none</span>  <span class="n">Version</span><span class="p">:</span> <span class="mi">2</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/06/04/centos-8-lxc/">CentOS 8 上安装 LXC</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2021-06-04T01:31:04+00:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2021/06/04/centos-8-lxc/#disqus_thread"
             data-disqus-identifier="http://www.malike.net.cn/blog/2021/06/04/centos-8-lxc/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>一、安装 LXC 包</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum install -y epel-release
</span><span class='line'>yum update -y
</span><span class='line'>yum install -y lxc lxc-devel lxc-templates dnsmasq iptables debootstrap
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>epel-release</code> : <a href="https://fedoraproject.org/wiki/EPEL">Extra Packages for Enterprise Linux (EPEL)</a> 仓库配置文件，因 EPEL 才包含 LXC 相关包。</li>
<li><code>dnsmasq</code> 和 <code>iptables</code> 为后续配置 LXC 网络。</li>
<li><code>debootstrap</code> 为后续安装 Ubuntu 容器。</li>
</ul>


<p>安装 LXC 模板</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>yum install -y gcc make
</span><span class='line'>wget -O- https://linuxcontainers.org/downloads/lxc/lxc-templates-3.0.4.tar.gz <span class="p">|</span> tar zx
</span><span class='line'><span class="nb">cd </span>lxc-templates-3.0.4
</span><span class='line'>./configure --prefix<span class="o">=</span>/usr --localstatedir<span class="o">=</span>/var
</span><span class='line'>make install
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>虽然 <code>lxc-templates</code> 包，但该包未包含 Ubuntu 容器模板。故还须从其源码安装。</li>
<li><code>lxc-templates-3.0.4</code> 并不需要编译任何 C 程序，但 <code>configure</code> 将检查 <code>gcc</code>。故须安装 <code>gcc</code></li>
<li>安装模板后，若不需要 <code>gcc</code> 和 <code>make</code> ，则可自行 <strong>卸载</strong> 。</li>
</ul>


<h2>二、配置 LXC 网络</h2>

<p>LXC 存在 3 种网络：</p>

<h3>虚拟网络</h3>

<p>创建虚拟网卡 <code>lxcbr0</code> ，作为容器虚拟网络的网桥：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo</span> <span class="s1">&#39;USE_LXC_BRIDGE=&quot;true&quot;&#39;</span> &gt; /etc/sysconfig/lxc
</span><span class='line'>systemctl <span class="nb">enable</span> --now lxc-net.service
</span><span class='line'>systemctl start lxc-net
</span><span class='line'>
</span><span class='line'>cat &gt; /etc/lxc/default.conf <span class="s">&lt;&lt;EOF</span>
</span><span class='line'><span class="s">lxc.net.0.type = veth</span>
</span><span class='line'><span class="s">lxc.net.0.flags = up</span>
</span><span class='line'><span class="s">lxc.net.0.link = lxcbr0</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<h3>共享 host 网络</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo</span> <span class="s1">&#39;lxc.net.0.type = none&#39;</span> &gt; /etc/lxc/default.conf
</span></code></pre></td></tr></table></div></figure>


<p>因容器与 host 在同一网络名字空间，容器中进程监听端口不能与 host 中端口相同，否则监听失败，如 <code>sshd</code></p>

<h3>loopback 网络</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo</span> <span class="s1">&#39;lxc.net.0.type = empty&#39;</span> &gt; /etc/lxc/default.conf
</span></code></pre></td></tr></table></div></figure>


<p>默认不配置或如上述，容器仅存在 loopback 网络。</p>

<h2>三、创建容器</h2>

<p>以安装 Ubuntu 20.04 容器为例：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc-create -n focal -t ubuntu <span class="se">\</span>
</span><span class='line'>  -- -r focal <span class="se">\</span>
</span><span class='line'>  --mirror http://cn.archive.ubuntu.com/ubuntu/ <span class="se">\</span>
</span><span class='line'>  --security-mirror http://cn.archive.ubuntu.com/ubuntu/
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>-n</code> ：容器名。</li>
<li><code>-t</code> ：模板名，对应 <code>/usr/share/lxc/templates/lxc-*</code> 文件。</li>
<li><code>--</code> ：其后为传入 <code>/usr/share/lxc/templates/lxc-ubuntu</code> 的参数。</li>
<li><code>-r</code> ： Ubuntu 发行代号，默认为主机的 Ubuntu 发行代号，否则为最近 LTS</li>
<li><code>--mirror</code> 和 <code>--security-mirror</code> ：为加速创建，两者设置为国内镜像。</li>
</ul>


<p>其它参数：</p>

<ul>
<li><code>-u &lt;user&gt;</code> : 容器用户名，默认 <code>ubuntu</code> 。</li>
<li><code>--password &lt;password&gt;</code> ：容器密码，默认 <code>ubuntu</code> 。</li>
<li><code>-S &lt;keyfile&gt;</code> : SSH 私钥文件。</li>
</ul>


<p>其它模板，如 CentOS ，可通过 <code>/usr/share/lxc/templates/lxc-centos -h</code> 查看相关参数。</p>

<h2>四、启动容器</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc-start focal
</span></code></pre></td></tr></table></div></figure>


<p>登录</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc-console focal
</span></code></pre></td></tr></table></div></figure>


<h2>五、查看容器</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc-info focal
</span></code></pre></td></tr></table></div></figure>


<p>输出形如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Name:           focal
</span><span class='line'>State:          RUNNING
</span><span class='line'>PID:            26063
</span><span class='line'>IP:             &lt;container ip&gt;
</span><span class='line'>CPU use:        0.35 seconds
</span><span class='line'>BlkIO use:      26.36 MiB
</span><span class='line'>Memory use:     21.13 MiB
</span><span class='line'>KMem use:       <span class="m">0</span> bytes
</span><span class='line'>Link:           vethJI5UF9
</span><span class='line'> TX bytes:      1.51 KiB
</span><span class='line'> RX bytes:      2.18 KiB
</span><span class='line'> Total bytes:   3.68 KiB
</span></code></pre></td></tr></table></div></figure>


<h2>六、端口转发</h2>

<p>仅以将主机端口 <code>2222</code> 重定向至容器 <code>22</code> 为例（须将 <code>&lt;container ip&gt;</code> 替换为容器 IP ）。</p>

<p>以下两者取其一，若未安装 <code>firewalld</code> ，则采用 <code>iptables</code> ：</p>

<h3>iptables</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>iptables -t nat -A PREROUTING -p tcp -i lxcbr0 --dport <span class="m">2222</span> -j DNAT --to-destination &lt;container ip&gt;:22
</span></code></pre></td></tr></table></div></figure>


<p>将上述命令写入 <code>/etc/rc.local</code> ，从而保证重启依旧生效：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo</span> <span class="s1">&#39;iptables -t nat -A PREROUTING -p tcp -i lxcbr0 --dport 2222 -j DNAT --to-destination &lt;container ip&gt;:22&#39;</span> &gt; /etc/rc.local
</span></code></pre></td></tr></table></div></figure>


<h3>firewalld</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>firewall-cmd --zone<span class="o">=</span>public --add-forward-port<span class="o">=</span><span class="nv">port</span><span class="o">=</span>2222:proto<span class="o">=</span>tcp:toport<span class="o">=</span>22:toaddr<span class="o">=</span>&lt;container ip&gt; --permanent
</span><span class='line'>firewall-cmd --zone<span class="o">=</span>public --add-port<span class="o">=</span>2222/tcp --permanent
</span><span class='line'>firewall-cmd --reload
</span></code></pre></td></tr></table></div></figure>


<h2>七、参考</h2>

<ul>
<li><a href="https://www.oreilly.com/library/view/containerization-with-lxc/9781785888946/ch05s02.html">Connecting LXC to the host network</a></li>
<li><a href="https://fedoraproject.org/wiki/LXC">Fedora LXC</a></li>
<li><a href="https://www.cyberciti.biz/faq/how-to-set-up-a-firewall-using-firewalld-on-centos-8/">How to set up a firewall using FirewallD on CentOS 8</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/03/15/fail2ban-tutorial-1/">Fail2Ban 简介 （一）</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2021-03-15T07:15:05+00:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2021/03/15/fail2ban-tutorial-1/#disqus_thread"
             data-disqus-identifier="http://www.malike.net.cn/blog/2021/03/15/fail2ban-tutorial-1/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Fail2Ban 是入侵检测软件框架，保护计算机免受暴力破解（brute-force attack）。以 Python 语言编写，能运行于具有包（packet）控制或防火墙的 POSIX 系统，如 iptables 或 TCP Wrapper.</p>

<p>鉴于互联网针对 VPS 暴力破解 SSH 越来越频繁，以下以 Ubuntu 为例，介绍如何利用 Fail2Ban 有效禁止 SSH 破解。</p>

<h2>一、安装</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get install -y fail2ban
</span></code></pre></td></tr></table></div></figure>


<h2>二、配置</h2>

<p>Fail2Ban 配置文件格式 <a href="https://en.wikipedia.org/wiki/INI_file">INI</a>，存于 <code>/etc/fail2ban</code> 目录：</p>

<ul>
<li><code>fail2ban.conf</code> : <code>fail2ban</code> 程序运行的日志和数据库等参数。</li>
<li><code>jail.conf</code> : 禁止（ban）相关参数。</li>
<li><code>filter.d/*</code> : <code>jail.conf</code> 中涉及“节”（section，如 <code>[sshd]</code> ）的过滤器，由正则表达式构成。</li>
<li><code>action.d/*</code> : <code>jail.conf</code> 中涉及“节”（section，如 <code>[sshd]</code> ）的处理器。</li>
</ul>


<p>它们皆为安装文件，直接修改将导致后续升级 <strong>无法自动合并</strong> 配置文件。Fail2Ban 提供了自定义配置文件的机制:</p>

<ul>
<li><code>fail2ban.conf</code> 可依此通过 <code>fail2ban.d/*</code> 和 <code>fail2ban.local</code> 来重定义相关选项。</li>
<li><code>jail.conf</code> 可依此通过 <code>jail.d/*</code> 和 <code>jail.local</code> 来重定义相关选项。</li>
</ul>


<p>默认安装，<code>/etc/fail2ban/jail.d/defaults-debian.conf</code> <strong>已启用</strong> <code>sshd</code> 的 jail</p>

<p>通常，除 <code>jail.conf</code> 外，不需要改变配置。以下着重介绍 <code>jail.conf</code> 中的参数，它们不仅是默认（全局）参数（隶属于 <code>[DEFAULT]</code>），而且可在具体 <code>jail</code> 中重定义（如 <code>[sshd]</code>）。</p>

<h3>常用参数</h3>

<ul>
<li><code>ignoreip</code> : 忽略不 IP 地址（CIDR 格式）或机器名，以空格分隔。</li>
<li><code>bantime</code> : 主机被禁止时长，默认 600 秒。</li>
<li><code>maxretry</code> : 在 <code>findtime</code> 时间窗口中，允许主机认证失败次数。达到最大次数，主机将被禁止。</li>
<li><code>findtime</code> : 查找主机认证失败的时间窗口。 <strong>不意味</strong> 着每隔 <code>findtime</code> 时间扫描一次日志。</li>
</ul>


<p>高版本 Fail2ban 支持 <code>s</code> （秒）, <code>m</code> （分）和 <code>d</code> （天）作为时间单位，如 <code>10m</code> 和 <code>1d</code></p>

<h3><code>backend</code></h3>

<p>默认 <code>auto</code> ，支持 4 种文件修改的监控后端：</p>

<ul>
<li><code>pynotify</code> : <a href="https://en.wikipedia.org/wiki/Inotify">inotify</a> 的 Python 绑定。在 Debian/Ubuntu 中，对应 <code>python3-pyinotify</code> 包。</li>
<li><code>gamin</code> :  KDE 和 GNOME 等桌面使用的文件监控系统，通常基于 <a href="https://en.wikipedia.org/wiki/Inotify">inotify</a> 实现。 在 Debian/Ubuntu 中，对应 <code>gamin</code> 包。</li>
<li><code>polling</code> : 周期性扫描相关系统日志。相对于其它几种后端，或将占用 <strong>更多</strong> CPU 时间。</li>
<li><code>systemd</code> :  通过 Systemd 的 Python 绑定来访问 systemd 日志，<code>logpath</code> 将无效。 在 Debian/Ubuntu 中，对应 <code>python3-systemd</code> 包。</li>
<li><code>auto</code> : 依此尝试 <code>pyinotify</code> , <code>gamin</code> 和 <code>polling</code></li>
</ul>


<p>通常，在安装 <code>fail2ban</code> 安装包时，将自动安装 <code>iptables</code> , <code>whois</code> , <code>python3-pyinotify</code> 和 <code>python3-systemd</code> ，即启用 <code>pyinotify</code> 后端。除非 APT 配置 <code>APT::Install-Recommends "false";</code> （如：<code>/etc/apt/apt.conf</code>）或 <code>--no-install--recommends</code> 。</p>

<h3>最佳实践</h3>

<p>建议将 <code>bantime</code> 设为 <code>86400</code> （即 1 天）。如 <code>jail.local</code> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>DEFAULT<span class="o">]</span>
</span><span class='line'><span class="nv">bantime</span> <span class="o">=</span> 86400
</span><span class='line'><span class="nv">findtime</span> <span class="o">=</span> 600
</span><span class='line'><span class="nv">maxretry</span> <span class="o">=</span> 3
</span></code></pre></td></tr></table></div></figure>


<p>或</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>sshd<span class="o">]</span>
</span><span class='line'><span class="nv">bantime</span> <span class="o">=</span> 86400
</span><span class='line'><span class="nv">findtime</span> <span class="o">=</span> 600
</span><span class='line'><span class="nv">maxretry</span> <span class="o">=</span> 3
</span></code></pre></td></tr></table></div></figure>


<p>修改后，须重载 <code>fail2ban</code> ：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo service fail2ban reload
</span></code></pre></td></tr></table></div></figure>


<p><code>/var/log/fail2ban.log</code> 将出现类似：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>2021-02-20 17:04:59,580 fail2ban.observer       <span class="o">[</span>2615<span class="o">]</span>: INFO    Observer start...
</span><span class='line'>2021-02-20 17:04:59,583 fail2ban.database       <span class="o">[</span>2615<span class="o">]</span>: INFO    Connected to fail2ban persistent database <span class="s1">&#39;/var/lib/fail2ban/fail2ban.sqlite3&#39;</span>
</span><span class='line'>2021-02-20 17:04:59,583 fail2ban.jail           <span class="o">[</span>2615<span class="o">]</span>: INFO    Creating new jail <span class="s1">&#39;sshd&#39;</span>
</span><span class='line'>2021-02-20 17:04:59,593 fail2ban.jail           <span class="o">[</span>2615<span class="o">]</span>: INFO    Jail <span class="s1">&#39;sshd&#39;</span> uses pyinotify <span class="o">{}</span>
</span><span class='line'>2021-02-20 17:04:59,596 fail2ban.jail           <span class="o">[</span>2615<span class="o">]</span>: INFO    Initiated <span class="s1">&#39;pyinotify&#39;</span> backend
</span><span class='line'>2021-02-20 17:04:59,597 fail2ban.filter         <span class="o">[</span>2615<span class="o">]</span>: INFO      maxLines: 1
</span><span class='line'>2021-02-20 17:04:59,611 fail2ban.filter         <span class="o">[</span>2615<span class="o">]</span>: INFO      maxRetry: 3
</span><span class='line'>2021-02-20 17:04:59,611 fail2ban.filter         <span class="o">[</span>2615<span class="o">]</span>: INFO      findtime: 600
</span><span class='line'>2021-02-20 17:04:59,611 fail2ban.actions        <span class="o">[</span>2615<span class="o">]</span>: INFO      banTime: 86400
</span><span class='line'>2021-02-20 17:04:59,611 fail2ban.filter         <span class="o">[</span>2615<span class="o">]</span>: INFO      encoding: UTF-8
</span><span class='line'>2021-02-20 17:04:59,611 fail2ban.filter         <span class="o">[</span>2615<span class="o">]</span>: INFO    Added logfile: <span class="s1">&#39;/var/log/auth.log&#39;</span> <span class="o">(</span><span class="nv">pos</span> <span class="o">=</span> 34274, <span class="nb">hash</span> <span class="o">=</span> 5cdc6285962a0352611a54aa860667fc35ededc1<span class="o">)</span>
</span><span class='line'>2021-02-20 17:04:59,614 fail2ban.jail           <span class="o">[</span>2615<span class="o">]</span>: INFO    Jail <span class="s1">&#39;sshd&#39;</span> started
</span><span class='line'>2021-02-20 17:08:12,674 fail2ban.server         <span class="o">[</span>2615<span class="o">]</span>: INFO    Reload all jails
</span><span class='line'>2021-02-20 17:08:12,674 fail2ban.server         <span class="o">[</span>2615<span class="o">]</span>: INFO    Reload jail <span class="s1">&#39;sshd&#39;</span>
</span><span class='line'>2021-02-20 17:08:12,674 fail2ban.filter         <span class="o">[</span>2615<span class="o">]</span>: INFO      maxLines: 1
</span><span class='line'>2021-02-20 17:08:12,674 fail2ban.filter         <span class="o">[</span>2615<span class="o">]</span>: INFO      maxRetry: 3
</span><span class='line'>2021-02-20 17:08:12,675 fail2ban.filter         <span class="o">[</span>2615<span class="o">]</span>: INFO      findtime: 600
</span><span class='line'>2021-02-20 17:08:12,675 fail2ban.actions        <span class="o">[</span>2615<span class="o">]</span>: INFO      banTime: 86400
</span><span class='line'>2021-02-20 17:08:12,675 fail2ban.filter         <span class="o">[</span>2615<span class="o">]</span>: INFO      encoding: UTF-8
</span><span class='line'>2021-02-20 17:08:12,675 fail2ban.server         <span class="o">[</span>2615<span class="o">]</span>: INFO    Jail <span class="s1">&#39;sshd&#39;</span> reloaded
</span><span class='line'>2021-02-20 17:08:12,675 fail2ban.server         <span class="o">[</span>2615<span class="o">]</span>: INFO    Reload finished.
</span></code></pre></td></tr></table></div></figure>


<h2>三、查看状态</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo fail2ban-client status sshd
</span></code></pre></td></tr></table></div></figure>


<p>输出类似：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Status <span class="k">for</span> the jail: sshd
</span><span class='line'><span class="p">|</span>- Filter
</span><span class='line'><span class="p">|</span>  <span class="p">|</span>- Currently failed: 2
</span><span class='line'><span class="p">|</span>  <span class="p">|</span>- Total failed:     5343
</span><span class='line'><span class="p">|</span>  <span class="sb">`</span>- File list:        /var/log/auth.log
</span><span class='line'><span class="sb">`</span>- Actions
</span><span class='line'>   <span class="p">|</span>- Currently banned: 178
</span><span class='line'>   <span class="p">|</span>- Total banned:     1354
</span><span class='line'>   <span class="sb">`</span>- Banned IP list:   ...
</span></code></pre></td></tr></table></div></figure>


<p>列表 iptables 的规则：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>iptables -S
</span></code></pre></td></tr></table></div></figure>


<p>输出类似：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>-P INPUT ACCEPT
</span><span class='line'>-P FORWARD ACCEPT
</span><span class='line'>-P OUTPUT ACCEPT
</span><span class='line'>-N fail2ban-ssh
</span><span class='line'>-A INPUT -p tcp -m multiport --dports <span class="m">22</span> -j fail2ban-ssh
</span><span class='line'>-A fail2ban-nginx-http-auth -j RETURN
</span><span class='line'>-A fail2ban-ssh -s &lt;IP 1&gt; -j REJECT --reject-with icmp-port-unreachable
</span><span class='line'>-A fail2ban-ssh -s &lt;IP 2&gt; -j REJECT --reject-with icmp-port-unreachable
</span><span class='line'>...
</span><span class='line'>-A fail2ban-ssh -j RETURN
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/07/19/import-ubuntu-duplciate-root-vg/">如何导入 Ubuntu 重复 Root 卷组</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2020-07-19T23:30:00+00:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2020/07/19/import-ubuntu-duplciate-root-vg/#disqus_thread"
             data-disqus-identifier="http://www.malike.net.cn/blog/2020/07/19/import-ubuntu-duplciate-root-vg/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>场景</h2>

<ul>
<li>某云平台的 Ubuntu 虚拟机运行中突遇挂起，重启时挂起于某阶段，且无法进入恢复模式。</li>
<li>因该云平台限制或问题，无法通过 Ubuntu 安装 ISO 引导该虚拟机。</li>
<li>该虚拟机的 root 分区位于 LVM 卷组上。</li>
</ul>


<p>当时，基本思路为挂载问题虚拟机的虚拟盘至新虚拟机，通过后者导入原虚拟盘的卷组，从而备份出重要数据。</p>

<p>然而，恰好该云平台仅有该虚拟机的原始模板，新实例的虚拟盘与旧盘：</p>

<ul>
<li>PV UUID 重复</li>
<li>VG UUID 和名称重复</li>
</ul>


<p>导致无法激活旧卷组。</p>

<h2>办法</h2>

<p>以下以 VirtualBox 安装 Ubuntu 20.04 虚拟机，克隆其系统盘为新虚拟盘，并将新盘加入该虚拟机来模拟场景。</p>

<h3>启动系统</h3>

<p>启动虚拟机将遇到 <strong>重复 PV</strong> 错误：</p>

<p><img src="/images/boot-focal-duplicate-root-vg.png" alt="Boot Ubuntu 20.04 duplicate root VG" /></p>

<p>进入 initramfs shell ，为了避免激活 root 卷组失败，暂时删除 <code>/dev/sdb</code> ：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo </span><span class="m">1</span> &gt; /sys/block/sdb/device/delete
</span><span class='line'>vgchange -ay
</span><span class='line'><span class="nb">exit</span>
</span></code></pre></td></tr></table></div></figure>


<p>将正常进入系统。</p>

<h3>扫描 <code>/dev/sdb</code></h3>

<p>登录系统，切换 root 用户, 重新扫密 <code>/dev/sdb</code> ：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo</span> <span class="s1">&#39;- - -&#39;</span> &gt; /sys/class/scsi_host/host1/scan
</span></code></pre></td></tr></table></div></figure>


<p>查看内核日志：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>dmesg <span class="p">|</span> tail
</span></code></pre></td></tr></table></div></figure>


<p>可发现 <code>/dev/sdb</code> 被加入系统：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>  747.671254<span class="o">]</span> scsi 1:0:0:0: Direct-Access     ATA      VBOX HARDDISK    1.0  PQ: <span class="m">0</span> ANSI: 5
</span><span class='line'><span class="o">[</span>  747.674322<span class="o">]</span> sd 1:0:0:0: <span class="o">[</span>sdb<span class="o">]</span> <span class="m">20971520</span> 512-byte logical blocks: <span class="o">(</span>10.7 GB/10.0 GiB<span class="o">)</span>
</span><span class='line'><span class="o">[</span>  747.674345<span class="o">]</span> sd 1:0:0:0: <span class="o">[</span>sdb<span class="o">]</span> Write Protect is off
</span><span class='line'><span class="o">[</span>  747.674350<span class="o">]</span> sd 1:0:0:0: <span class="o">[</span>sdb<span class="o">]</span> Mode Sense: <span class="m">00</span> 3a <span class="m">00</span> 00
</span><span class='line'><span class="o">[</span>  747.674382<span class="o">]</span> sd 1:0:0:0: <span class="o">[</span>sdb<span class="o">]</span> Write cache: enabled, <span class="nb">read </span>cache: enabled, doesn<span class="err">&#39;</span>t support DPO or FUA
</span><span class='line'><span class="o">[</span>  747.678357<span class="o">]</span> sd 1:0:0:0: Attached scsi generic sg1 <span class="nb">type </span>0
</span><span class='line'><span class="o">[</span>  747.681741<span class="o">]</span>  sdb: sdb1 sdb2 &lt; sdb5 &gt;
</span><span class='line'><span class="o">[</span>  747.681959<span class="o">]</span> sd 1:0:0:0: <span class="o">[</span>sdb<span class="o">]</span> Attached SCSI disk
</span></code></pre></td></tr></table></div></figure>


<p>这里 <code>/dev/sda</code> 位于 SCSI host 0 ，而 <code>/dev/sdb</code> 位于 SCSI host 1 。实际环境中，若无法确定目标盘在第几个 host ，可全部扫描一遍：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="k">for</span> i in /sys/class/scsi_host/host*/scan<span class="p">;</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">echo</span> <span class="s1">&#39;- - -&#39;</span> &gt; <span class="nv">$i</span>
</span><span class='line'><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<h3>导入重复 VG</h3>

<p>以新卷组名 <code>ubuntu</code> 执行 <a href="http://manpages.ubuntu.com/manpages/focal/man8/vgimportclone.8.html">vgimportclone</a> 导入重复 VG ：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vgimportclone -n ubuntu /dev/sdb5
</span></code></pre></td></tr></table></div></figure>


<p>输出：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>  WARNING: Not using device /dev/sdb5 <span class="k">for</span> PV kyDNAt-ONdQ-9MIb-4tJO-w8kC-WnEY-xmJ2qj.
</span><span class='line'>  WARNING: PV kyDNAt-ONdQ-9MIb-4tJO-w8kC-WnEY-xmJ2qj prefers device /dev/sda5 because device is used by LV.
</span></code></pre></td></tr></table></div></figure>


<p><code>/dev/sdb5</code> 为新盘 VG 的 PV 。实际环境中，若 VG 存在多个 PV，则须全部作为该命令的参数。</p>

<h3>激活新卷组</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vgchange -ay
</span></code></pre></td></tr></table></div></figure>


<p>输出：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>  <span class="m">2</span> logical volume<span class="o">(</span>s<span class="o">)</span> in volume group <span class="s2">&quot;ubuntu&quot;</span> now active
</span><span class='line'>  <span class="m">2</span> logical volume<span class="o">(</span>s<span class="o">)</span> in volume group <span class="s2">&quot;vgfocal&quot;</span> now active
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/05/05/lxd-tutorial-1/">LXD简介（一）</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2020-05-05T17:19:21+00:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2020/05/05/lxd-tutorial-1/#disqus_thread"
             data-disqus-identifier="http://www.malike.net.cn/blog/2020/05/05/lxd-tutorial-1/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://linuxcontainers.org/lxd/introduction/">LXD</a> 是基于LXC容器的管理程序（hypervisor），它由开发 Ubuntu 的公司 Canonical 创建和维护。</p>

<p>它由3个组建构成：</p>

<ul>
<li><code>lxd</code> ：系统守护进程，它导出能被本地和网络访问的 RESTful API</li>
<li><code>lxc</code> ：客户端命令行，它能跨网络管理多个容器主机。</li>
<li><code>nova-compute-lxd</code> ： OpenStack Nova 插件，它使 OpenStack 如虚拟机一般，管理容器。</li>
</ul>


<h2>一、安装</h2>

<p>因 Ubuntu 16.04 LXD 2.x 和 Ubuntu 18.04 LXD 3.x 版本都较旧，且 Ubuntu 20.04 放弃 <code>apt</code> 安装 LXD 。</p>

<p>请据 <a href="/blog/2020/04/30/snap-tutorial/">Snap简介</a> 安装 LXD</p>

<p>为避免每次 <code>sudo lxc</code> ，可将 <code>lxd</code> 组加入当前（非root）用户的附加组：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo usermod -aG lxd <span class="nv">$USER</span>
</span></code></pre></td></tr></table></div></figure>


<h2>二、初始化</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo lxd init
</span></code></pre></td></tr></table></div></figure>


<p>输出：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Would you like to use LXD clustering? <span class="o">(</span>yes/no<span class="o">)</span> <span class="o">[</span><span class="nv">default</span><span class="o">=</span>no<span class="o">]</span>:
</span><span class='line'>
</span><span class='line'><span class="c"># 配置存储池</span>
</span><span class='line'>Do you want to configure a new storage pool? <span class="o">(</span>yes/no<span class="o">)</span> <span class="o">[</span><span class="nv">default</span><span class="o">=</span>yes<span class="o">]</span>:
</span><span class='line'>Name of the new storage pool <span class="o">[</span><span class="nv">default</span><span class="o">=</span>default<span class="o">]</span>:
</span><span class='line'>Name of the storage backend to use <span class="o">(</span>btrfs, dir, lvm, zfs, ceph<span class="o">)</span> <span class="o">[</span><span class="nv">default</span><span class="o">=</span>zfs<span class="o">]</span>: dir
</span><span class='line'>
</span><span class='line'>Would you like to connect to a MAAS server? <span class="o">(</span>yes/no<span class="o">)</span> <span class="o">[</span><span class="nv">default</span><span class="o">=</span>no<span class="o">]</span>:
</span><span class='line'>
</span><span class='line'><span class="c"># 创建虚拟网络</span>
</span><span class='line'>Would you like to create a new <span class="nb">local </span>network bridge? <span class="o">(</span>yes/no<span class="o">)</span> <span class="o">[</span><span class="nv">default</span><span class="o">=</span>yes<span class="o">]</span>:
</span><span class='line'>What should the new bridge be called? <span class="o">[</span><span class="nv">default</span><span class="o">=</span>lxdbr0<span class="o">]</span>:
</span><span class='line'>What IPv4 address should be used? <span class="o">(</span>CIDR subnet notation, “auto” or “none”<span class="o">)</span> <span class="o">[</span><span class="nv">default</span><span class="o">=</span>auto<span class="o">]</span>:
</span><span class='line'>What IPv6 address should be used? <span class="o">(</span>CIDR subnet notation, “auto” or “none”<span class="o">)</span> <span class="o">[</span><span class="nv">default</span><span class="o">=</span>auto<span class="o">]</span>:
</span><span class='line'>
</span><span class='line'><span class="c"># LXD 服务的网络配置</span>
</span><span class='line'>Would you like LXD to be available over the network? <span class="o">(</span>yes/no<span class="o">)</span> <span class="o">[</span><span class="nv">default</span><span class="o">=</span>no<span class="o">]</span>: yes
</span><span class='line'>Address to <span class="nb">bind </span>LXD to <span class="o">(</span>not including port<span class="o">)</span> <span class="o">[</span><span class="nv">default</span><span class="o">=</span>all<span class="o">]</span>:
</span><span class='line'>Port to <span class="nb">bind </span>LXD to <span class="o">[</span><span class="nv">default</span><span class="o">=</span>8443<span class="o">]</span>:
</span><span class='line'>Trust password <span class="k">for</span> new clients:
</span></code></pre></td></tr></table></div></figure>


<p>参看： <a href="https://snapcraft.io/install/lxd/ubuntu">How to install LXD on Ubuntu</a></p>

<h3>修改密码</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc config <span class="nb">set </span>core.trust_password <span class="s1">&#39;&lt;password&gt;&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>三、镜像</h2>

<p>LXD 默认提供3个远程镜像：</p>

<ul>
<li><code>ubuntu</code>: Ubuntu 稳定版镜像</li>
<li><code>ubuntu-daily</code>: Ubuntu 每日构建的镜像</li>
<li><code>images</code>: <a href="https://images.linuxcontainers.org/">其它发行版本的镜像</a>，主要包括:

<ul>
<li>Alpine</li>
<li>Archlinux</li>
<li>Centos/Oracle</li>
<li>Debian</li>
<li>Fedora</li>
<li>Gentoo</li>
<li>OpenSUSE</li>
<li>OpenWRT</li>
<li>Ubuntu</li>
</ul>
</li>
</ul>


<h3>列表本地镜像</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc image list
</span></code></pre></td></tr></table></div></figure>


<h3>列表Ubuntu镜像</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc image list ubuntu:
</span></code></pre></td></tr></table></div></figure>


<h3>列表其他镜像</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc image list images:
</span></code></pre></td></tr></table></div></figure>


<h3>注册镜像</h3>

<p>因上述镜像都在国外，复制镜像速度非常慢。可注册清华大学的镜像来加速使用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc remote add tuna-images https://mirrors.tuna.tsinghua.edu.cn/lxc-images/ --protocol<span class="o">=</span>simplestreams --public
</span></code></pre></td></tr></table></div></figure>


<p>以下主要以<code>tuna-images</code>为例。</p>

<h3>复制镜像</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc image cp tuna-images:ubuntu/20.04 <span class="nb">local</span>: --copy-aliases --auto-update --public
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>--copy-aliases</code> : 复制所有镜像别名。 每个镜像可能有多个别名，如 Ubuntu 20.04 的镜像的别名为 <code>20.04</code> 和 <code>focal</code> 等。</li>
<li><code>--auto-uppdate</code> : 自动更新镜像</li>
<li><code>--public</code> : 公开镜像，让其它机器可以复制它。后面将进一步介绍如何公开 LXD 端口。</li>
</ul>


<h2>四、容器</h2>

<h3>创建容器，但不启动</h3>

<p>默认为 64-bit 容器：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc init tuna-images:ubuntu/20.04 focal
</span></code></pre></td></tr></table></div></figure>


<p>若须 32-bit 容器，则</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc init tuna-images:ubuntu/20.04/i386 focal
</span></code></pre></td></tr></table></div></figure>


<h3>创建容器，并启动容器</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc launch tuna-images:ubuntu/20.04 focal
</span></code></pre></td></tr></table></div></figure>


<p>相当于</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc init tuna-images:ubuntu/20.04 focal
</span><span class='line'>lxc start focal
</span></code></pre></td></tr></table></div></figure>


<p>直接从远程镜像初始化或启动，存在如下缺点：</p>

<ul>
<li>每次初始化或启动，可能会从远程下载镜像（若存在更新），造成初始化或启动速度缓慢。</li>
<li>未复制任何别名至本地，不利于复用。如 <code>lxc image ls</code> ：</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>+-----------------------+--------------+--------+--------------------------------------+--------------+-----------+---------+-----------------------------+
</span><span class='line'><span class="p">|</span>         ALIAS         <span class="p">|</span> FINGERPRINT  <span class="p">|</span> PUBLIC <span class="p">|</span>             DESCRIPTION              <span class="p">|</span> ARCHITECTURE <span class="p">|</span>   TYPE    <span class="p">|</span>  SIZE   <span class="p">|</span>         UPLOAD DATE         <span class="p">|</span>
</span><span class='line'>+-----------------------+--------------+--------+--------------------------------------+--------------+-----------+---------+-----------------------------+
</span><span class='line'><span class="p">|</span>                       <span class="p">|</span> 36e7b3c6bdea <span class="p">|</span> yes    <span class="p">|</span> Ubuntu focal amd64 <span class="o">(</span>20200504_07:42<span class="o">)</span>  <span class="p">|</span> x86_64       <span class="p">|</span> CONTAINER <span class="p">|</span> 97.40MB <span class="p">|</span> May 5, <span class="m">2020</span> at 8:07am <span class="o">(</span>UTC<span class="o">)</span> <span class="p">|</span>
</span><span class='line'>+-----------------------+--------------+--------+--------------------------------------+--------------+-----------+---------+-----------------------------+
</span></code></pre></td></tr></table></div></figure>


<p>故最佳实践为首先复制镜像，然后初始化或启动：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc image cp tuna-images:ubuntu/20.04 <span class="nb">local</span>: --copy-aliases --auto-update --public
</span><span class='line'>lxc launch ubuntu/20.04 focal
</span></code></pre></td></tr></table></div></figure>


<h3>启动/停止容器</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc start focal
</span><span class='line'>lxc stop focal
</span></code></pre></td></tr></table></div></figure>


<h3>列表容器</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc list
</span></code></pre></td></tr></table></div></figure>


<p>或 快速列表</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc list --fast
</span></code></pre></td></tr></table></div></figure>


<h3>查看容器详细信息</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc info focal
</span></code></pre></td></tr></table></div></figure>


<h3>运行命令</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo lxc <span class="nb">exec </span>focal -- /bin/bash
</span></code></pre></td></tr></table></div></figure>


<h3>上传/下载文件</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc file pull focal/etc/hosts .
</span><span class='line'>lxc file push /etc/hosts focal/tmp/tmp
</span></code></pre></td></tr></table></div></figure>


<h2>五、虚拟机</h2>

<p>LXD 3.19 开始支持创建虚拟机:</p>

<p>简单的说，所有容器相关的命令加<code>--vm</code>。</p>

<h3>复制镜像</h3>

<p>若类似复制容器命令：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc image copy tuna-images:ubuntu:20.04 <span class="nb">local</span>: --copy-aliases --auto-update --public --vm
</span></code></pre></td></tr></table></div></figure>


<p>则可能 <strong>覆盖</strong> 本地容器 ubuntu 20.04 的别名，造成后者 <strong>无别名</strong>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>+-----------------------+--------------+--------+-------------------------------------+--------------+-----------------+----------+-----------------------------+
</span><span class='line'><span class="p">|</span>         ALIAS         <span class="p">|</span> FINGERPRINT  <span class="p">|</span> PUBLIC <span class="p">|</span>             DESCRIPTION             <span class="p">|</span> ARCHITECTURE <span class="p">|</span>      TYPE       <span class="p">|</span>   SIZE   <span class="p">|</span>         UPLOAD DATE         <span class="p">|</span>
</span><span class='line'>+-----------------------+--------------+--------+-------------------------------------+--------------+-----------------+----------+-----------------------------+
</span><span class='line'><span class="p">|</span> ubuntu/focal <span class="o">(</span><span class="m">7</span> more<span class="o">)</span> <span class="p">|</span> 1bb3c2f730c5 <span class="p">|</span> yes    <span class="p">|</span> Ubuntu focal amd64 <span class="o">(</span>20200504_07:42<span class="o">)</span> <span class="p">|</span> x86_64       <span class="p">|</span> VIRTUAL-MACHINE <span class="p">|</span> 231.06MB <span class="p">|</span> May 5, <span class="m">2020</span> at 8:08am <span class="o">(</span>UTC<span class="o">)</span> <span class="p">|</span>
</span><span class='line'>+-----------------------+--------------+--------+-------------------------------------+--------------+-----------------+----------+-----------------------------+
</span><span class='line'><span class="p">|</span>                       <span class="p">|</span> 36e7b3c6bdea <span class="p">|</span> yes    <span class="p">|</span> Ubuntu focal amd64 <span class="o">(</span>20200504_07:42<span class="o">)</span> <span class="p">|</span> x86_64       <span class="p">|</span> CONTAINER       <span class="p">|</span> 97.40MB  <span class="p">|</span> May 5, <span class="m">2020</span> at 8:07am <span class="o">(</span>UTC<span class="o">)</span> <span class="p">|</span>
</span><span class='line'>+-----------------------+--------------+--------+-------------------------------------+--------------+-----------------+----------+-----------------------------+
</span></code></pre></td></tr></table></div></figure>


<p>为了避免上述问题，自定义镜像别名，如以 <code>vm/</code> 作为镜像别名前缀：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc cpi tuna-images:ubuntu/20.04 <span class="nb">local</span>: --auto-update --public --vm --alias vm/ubuntu/focal --alias vm/ubuntu/20.04
</span></code></pre></td></tr></table></div></figure>


<h3>创建虚拟机</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc launch tuna-images:ubuntu/20.04 focal-vm --vm --profile default --profile vm
</span></code></pre></td></tr></table></div></figure>


<p>Ubuntu 16.04 默认内核 4.4 ，将遇到</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Creating focal-vm
</span><span class='line'>Starting focal-vm
</span><span class='line'>Error: Failed to run: modprobe vhost_vsock: modprobe: FATAL: Module vhost_vsock not found in directory /lib/modules/4.4.0-176-generic
</span><span class='line'>Try <span class="sb">`</span>lxc info --show-log <span class="nb">local</span>:focal-vm<span class="sb">`</span> <span class="k">for</span> more info
</span></code></pre></td></tr></table></div></figure>


<p>须安装 4.15 (HWE) 内核，并重启：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get install --install-recommends linux-generic-hwe-16.04
</span></code></pre></td></tr></table></div></figure>


<h2>六、快照</h2>

<h3>创建只读快照</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc snapshot focal focal-s0
</span></code></pre></td></tr></table></div></figure>


<p>注：无列表快照的直接操作，只能通过获取容器的详细信息 <code>lxc info</code> 来获取的快照名字。</p>

<h3>还原快照</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc restore focal focal-s0
</span></code></pre></td></tr></table></div></figure>


<h3>删除快照</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc delete focal/focal-s0
</span></code></pre></td></tr></table></div></figure>


<h2>七、别名</h2>

<h3>创建别名</h3>

<p>模仿 Docker 删除镜像的 <code>docker rmi</code> ， 创建 <code>lxc rmi</code> ：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc <span class="nb">alias </span>add rmi <span class="s1">&#39;image rm&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>类似：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc <span class="nb">alias </span>add lsi <span class="s1">&#39;image ls&#39;</span>
</span><span class='line'>lxc <span class="nb">alias </span>add cpi <span class="s1">&#39;image cp&#39;</span>
</span><span class='line'>lxc <span class="nb">alias </span>add infoi <span class="s1">&#39;image info&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>列表别名</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc <span class="nb">alias </span>ls
</span></code></pre></td></tr></table></div></figure>


<h3>删除别名</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lxc <span class="nb">alias </span>rm infoi
</span></code></pre></td></tr></table></div></figure>


<h2>八、剖析</h2>

<p>lxd将数据存放于 <code>/var/snap/lxd/common/lxd</code> ：</p>

<ul>
<li><code>images</code>: 存放镜像文件</li>
<li><code>lxc</code>: 存放容器</li>
<li><code>lxd.db</code>：lxd元数据数据库，基于sqlite3</li>
<li><code>server.crt</code>：服务器证书</li>
<li><code>server.key</code>：服务器密钥</li>
<li><code>unix.socket</code>：lxd监听的本地套接口</li>
</ul>


<h2>参考</h2>

<ul>
<li><a href="https://linuxcontainers.org/lxd/getting-started-cli/">LXD Getting started - command line</a></li>
<li><a href="https://ubuntu.com/blog/lxd-in-4-easy-steps">LXD in 4 Easy Steps</a></li>
<li><a href="https://blog.simos.info/how-to-use-virtual-machines-in-lxd/">How to use virtual machines in LXD</a></li>
<li><a href="https://discuss.linuxcontainers.org/t/trying-lxd-virtual-machines/6182">Trying LXD virtual machines</a></li>
<li><a href="https://blog.simos.info/using-command-aliases-in-lxd-to-exec-a-shell/">Using command aliases in LXD to exec a shell</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/04/30/snap-tutorial/">Snap简介</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2020-04-30T19:40:24+00:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2020/04/30/snap-tutorial/#disqus_thread"
             data-disqus-identifier="http://www.malike.net.cn/blog/2020/04/30/snap-tutorial/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://snapcraft.io/">Snap</a> 是 Canonical 开发的包管理系统，默认安装于 Ubuntu 16.04 及其后的发行版本中。</p>

<p>优势：</p>

<ul>
<li>自包含：不受限于发行版的系统库版本，且每个包之间不存在运行库依赖。</li>
<li>只读挂载：应用程序不能修改或删除，且不会污染系统应用程序或库。</li>
<li>回退：内置回退旧版本。</li>
<li>快照：内置备份和恢复应用数据。</li>
<li>版本新：相比发行版更新缓慢，其应用程序版本都比较新。</li>
</ul>


<p>劣势主要为安装包占用较多存储空间。</p>

<p>以下主要以 LXD 的 snap 包为例。</p>

<h2>一、安装 snapd</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt install -y snapd
</span></code></pre></td></tr></table></div></figure>


<p>查看版本</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>snap version
</span></code></pre></td></tr></table></div></figure>


<h2>二、安装 snap 包</h2>

<p>为避免系统可能存在旧版本 LXD 与 snap 安装的最新版 LXD 冲突：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt remove --purge lxd lxd-client
</span></code></pre></td></tr></table></div></figure>


<p>然后：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo snap install lxd
</span></code></pre></td></tr></table></div></figure>


<p>默认 <code>stable</code> 频道，也可以指定 <code>edge</code> 频道：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo snap install --channel<span class="o">=</span>edge lxd
</span></code></pre></td></tr></table></div></figure>


<p>安装后，可切换频道。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo snap switch --channel<span class="o">=</span>stable lxd
</span></code></pre></td></tr></table></div></figure>


<p>相比 RPM 和 Debian 包需手动更新，snap 包将在后台自动更新。若需手动更新，则</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo snap refresh lxd
</span></code></pre></td></tr></table></div></figure>


<p>snap 还能切换频道并更新</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo snap refresh --channel<span class="o">=</span>beta lxd
</span></code></pre></td></tr></table></div></figure>


<p>snap 应用程序位于 <code>/snap/bin</code> ，如： <code>/snap/bin/lxd</code></p>

<p>为便于使用，可将该路径追加于 <code>~/.bashrc</code> 或 <code>~/.zshrc</code> 环境变量 <code>PATH</code> ，如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/snap/bin
</span></code></pre></td></tr></table></div></figure>


<h3>下载包</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>snap download lxd
</span></code></pre></td></tr></table></div></figure>


<h3>离线安装</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo snap ack lxd_17320.assert
</span><span class='line'>sudo snap install lxd_17320.snap
</span></code></pre></td></tr></table></div></figure>


<h2>三、搜索包</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>snap search &lt;snapname&gt;
</span></code></pre></td></tr></table></div></figure>


<p>也可通过浏览器在应用市场 <a href="https://snapcraft.io/">Snapcraft</a> 上搜索需要的包（应用）。</p>

<h2>四、列表已安装的包</h2>

<h3>列表所有包</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>snap list
</span></code></pre></td></tr></table></div></figure>


<p>输出：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Name      Version    Rev    Tracking       Publisher   Notes
</span><span class='line'>core      16-2.44.3  <span class="m">9066</span>   latest/stable  canonical✓  core
</span><span class='line'>core18    <span class="m">20200311</span>   <span class="m">1705</span>   latest/stable  canonical✓  base
</span><span class='line'>lxd       4.0.1      <span class="m">14804</span>  latest/stable  canonical✓  -
</span></code></pre></td></tr></table></div></figure>


<p>若 <code>--all</code> ， 则列表包的所有版本 (revision)</p>

<h3>列表指定包</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>snap list lxd
</span></code></pre></td></tr></table></div></figure>


<p>输出：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Name  Version  Rev    Tracking       Publisher   Notes
</span><span class='line'>lxd   4.0.1    <span class="m">14804</span>  latest/stable  canonical✓  -
</span></code></pre></td></tr></table></div></figure>


<h2>五、回退版本</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo snap revert lxd
</span></code></pre></td></tr></table></div></figure>


<p>若遇到当前版本bug，则可考虑回退程序。当前跟踪的 channel 不会因上一版本源于不同 channel 而改变。</p>

<ul>
<li><code>snap refesh</code> 不会更新已回退的包，除非指定包名，如：<code>snap refresh lxd</code></li>
<li>新版本发布，将继续自动更新已回退的包。</li>
</ul>


<h2>六、卸载 snap 包</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo snap remove lxd
</span></code></pre></td></tr></table></div></figure>


<p>卸载旧版本（释放空间）。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo snap remove --revision<span class="o">=</span><span class="m">14709</span> lxd
</span></code></pre></td></tr></table></div></figure>


<h2>七、启用/禁用 snap 包</h2>

<p>为避免卸载和重装而禁用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo snap disable lxd
</span></code></pre></td></tr></table></div></figure>


<p>反之：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo snap <span class="nb">enable </span>lxd
</span></code></pre></td></tr></table></div></figure>


<h2>八、服务</h2>

<h3>列表</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo snap services lxd
</span></code></pre></td></tr></table></div></figure>


<p>输出：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Service       Startup  Current   Notes
</span><span class='line'>lxd.activate  enabled  inactive  -
</span><span class='line'>lxd.daemon    enabled  active    socket-activated
</span></code></pre></td></tr></table></div></figure>


<h3>启动、停止和重启</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo snap stop lxd.daemon
</span><span class='line'>sudo snap start lxd.daemon
</span><span class='line'>sudo snap restart lxd.daemon
</span></code></pre></td></tr></table></div></figure>


<p>停止服务，并禁用自动启动：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo snap stop --disable lxd.daemon
</span></code></pre></td></tr></table></div></figure>


<p>开始服务，并启用自动启动：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo snap start --disable lxd.daemon
</span></code></pre></td></tr></table></div></figure>


<h3>查看日志</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo snap logs lxd
</span><span class='line'>sudo snap logs lxd.daemon
</span><span class='line'>sudo snap logs lxd -f <span class="c"># 类似tail -f</span>
</span></code></pre></td></tr></table></div></figure>


<h2>九、快照</h2>

<h3>创建</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo snap save
</span></code></pre></td></tr></table></div></figure>


<p>输出：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Set  Snap      Age    Version    Rev    Size    Notes
</span><span class='line'><span class="m">1</span>    core      42.2s  16-2.44.3  <span class="m">9066</span>     124B  -
</span><span class='line'><span class="m">1</span>    core18    42.2s  <span class="m">20200311</span>   <span class="m">1705</span>     123B  -
</span><span class='line'><span class="m">1</span>    lxd       42.2s  4.0.1      <span class="m">14890</span>   2187B  -
</span></code></pre></td></tr></table></div></figure>


<p>或指定包</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo snap save lxd
</span></code></pre></td></tr></table></div></figure>


<p>若 <code>--no-wait</code>， 则后台运行。</p>

<h3>列表</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>snap saved
</span></code></pre></td></tr></table></div></figure>


<p>或指定Set ID</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>snap saved --id<span class="o">=</span>1
</span></code></pre></td></tr></table></div></figure>


<h3>校验</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>snap check-snapshot 1
</span></code></pre></td></tr></table></div></figure>


<h3>还原</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>snap restore 1
</span></code></pre></td></tr></table></div></figure>


<h3>删除</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>snap forget 1
</span></code></pre></td></tr></table></div></figure>


<h2>十、剖析</h2>

<h3>包的安装</h3>

<p>相比 RPM 和 Debian 等传统安装包，通过解开来安装。</p>

<p>存于 <code>/var/lib/snapd</code> ，格式为 <a href="https://en.wikipedia.org/wiki/SquashFS">squashfs</a> 的 snap 包，不直接解开，而是（只读）挂载至 <code>/snap/&lt;snapname&gt;/&lt;revision&gt;</code> 目录。如：</p>

<p><code>lxd</code> 的 revision 14890 的包存储于 <code>/var/lib/snapd/snaps/lxd_14890.snap</code> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mount <span class="p">|</span> grep 14890
</span></code></pre></td></tr></table></div></figure>


<p>发现：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/var/lib/snapd/snaps/lxd_14890.snap on /snap/lxd/14890 <span class="nb">type </span>squashfs <span class="o">(</span>ro,nodev,relatime<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>另外， <code>/snap/&lt;snapname&gt;/current</code> 为当前版本挂载点，它为指向 <code>/snap/&lt;snapname&gt;/&lt;revision&gt;</code> 的符号链接。</p>

<p>而且，每个 snap 包含了不依赖系统库的完整的运行时库。</p>

<h3>包的缓存</h3>

<p>snap 为了加速二次安装，首次安装会将 snap 包缓存至 <code>/var/lib/snapd/cache</code> 。</p>

<p>目前为止， snap 未提供命令清楚缓存。若需 <strong>释放空间</strong> ，须手动删除该目录中的文件。</p>

<h3>包的运行数据</h3>

<p><code>/var/snap</code> 存储每个包的运行数据（或元数据）。如：<code>/var/snap/lxd</code> 主要为 lxd 的元数据。</p>

<p>该目录或将消耗大量的存储空间，因受制于 AppArmor ，不能通过移动目录（至另外分区）和符号链接来释放空间，须 <code>mount --bind</code> 移动的目录。</p>

<h3>包的应用程序</h3>

<p><code>/snap/bin</code> 存储指向包的应用程序（符号链接），如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ls -l /snap/bin/lxd
</span></code></pre></td></tr></table></div></figure>


<p>看到 <code>lxd</code> 仅为 <code>snap</code> 的符号链接</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>lrwxrwxrwx <span class="m">13</span> root <span class="m">29</span> 4月  12:10 /snap/bin/lxd -&gt; /usr/bin/snap
</span></code></pre></td></tr></table></div></figure>


<h3>快照</h3>

<p>每个包快照用独立的 zip 文件存储，包含：</p>

<ul>
<li><code>meta.json</code> : 描述快照内容、配置和校验码。</li>
<li><code>archive.tgz</code> : 包含系统数据。</li>
<li><code>user/&lt;username&gt;.tgz</code> : 包含每个系统的用户数据。</li>
</ul>


<p>快照存储于 <code>/var/lib/snapd/snapshots</code></p>

<h2>参考</h2>

<ul>
<li><a href="https://snapcraft.io/docs/getting-started">Snap Getting Started</a></li>
<li><a href="http://landofnightandday.blogspot.com/2018/06/disable-snap-core-service-on-ubuntu-1804.html">Disable snap core service on Ubuntu 18.04</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/04/19/ace-one-loop-per-thread/">用ACE实现One Loop Per Thread</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2020-04-19T19:20:02+00:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2020/04/19/ace-one-loop-per-thread/#disqus_thread"
             data-disqus-identifier="http://www.malike.net.cn/blog/2020/04/19/ace-one-loop-per-thread/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://www.cnblogs.com/Solstice/archive/2010/02/12/multithreaded_server.html#_Toc7583">one loop per thread</a> 即每个线程运行一个独立的事件循环 (event loop)，或称为 one event loop per thread 更准确。而且事件循环线程之间通常不存在同步或互斥的关系, 并发连接的处理能力随CPU核心数而扩展 (scalable)。</p>

<p><a href="http://www.dre.vanderbilt.edu/~schmidt/ACE.html">ACE</a> 拥有多种实现的Reactor:</p>

<ul>
<li><code>ACE_Select_Reactor</code> : 基于 <code>select</code> 的实现。</li>
<li><code>ACE_Dev_Poll_Reactor</code> : 基于 Linux <code>epoll</code> 或 BSD <code>/dev/poll</code> 的实现。</li>
<li><code>ACE_WFMO_Reactor</code> : 基于 Windows <code>WaitForMultipleObjects</code> 的实现</li>
</ul>


<p>它们都可用于实现 one loop per thread 模式。 相比 <code>ACE_TP_Reactor</code>：</p>

<ul>
<li><code>ACE_TP_Reactor</code> 继承于 <code>ACE_Select_Reactor</code> ，<strong>加锁</strong> 保证多线程竞争同一 Reactor 的安全。并行可扩展能力受限，且最大支持 1024 个描述符。</li>
<li>基于 <code>ACE_Dev_Poll_Reactor</code> 的 one loop er thread，每个线程拥有独立的 Reactor，线程之间不存在竞争。充分发挥并行能力，且最大支持几十万甚至百万个描述符。</li>
</ul>


<p>以下以 <code>ACE_Select_Reactor</code> 为例浅析实现的关键代码。更完备示例代码请参看我的 <a href="https://github.com/likema/ace_echod">ace_echod</a></p>

<h2>实现浅析</h2>

<h3>事件循环函数</h3>

<p><code>event_loop</code> 将作为线程函数运行于独立线程中，它与 ACE 教科书基本一样：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">ACE_THR_FUNC_RETURN</span> <span class="nf">event_loop</span><span class="p">(</span><span class="n">ACE_Reactor</span><span class="o">*</span> <span class="n">reactor</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">reactor</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">(</span><span class="n">ACE_OS</span><span class="o">::</span><span class="n">thr_self</span><span class="p">());</span> <span class="c1">// 将reactor “绑定” 本线程。</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">reactor</span><span class="o">-&gt;</span><span class="n">reactor_event_loop_done</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">reactor</span><span class="o">-&gt;</span><span class="n">run_reactor_event_loop</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>事件循环管理器</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">class</span> <span class="nc">Event_Loop_Manager</span> <span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>    <span class="c1">// 为简化，忽略 ctor 、dtor 和 close</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">bool</span> <span class="n">open</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">threads</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">// 创建Reactor数组。</span>
</span><span class='line'>        <span class="n">reactors_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">ACE_Reactor</span><span class="o">*</span><span class="p">[</span><span class="n">threads</span><span class="p">]);</span>
</span><span class='line'>        <span class="n">memset</span><span class="p">(</span><span class="n">reactors_</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ACE_Reactor</span><span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">threads</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 创建线程ID数组</span>
</span><span class='line'>        <span class="n">tids_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">ACE_thread_t</span><span class="p">[</span><span class="n">threads</span><span class="p">]);</span>
</span><span class='line'>        <span class="n">memset</span><span class="p">(</span><span class="n">tids_</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ACE_thread_t</span><span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">threads</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 创建事件循环</span>
</span><span class='line'>        <span class="n">threads_</span> <span class="o">=</span> <span class="n">threads</span><span class="p">;</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">threads_</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">reactors_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ACE_Reactor</span><span class="p">(</span><span class="k">new</span> <span class="n">ACE_Select_Reactor</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">false</span><span class="p">);</span>
</span><span class='line'>            <span class="n">ACE_Thread_Manager</span><span class="o">::</span><span class="n">instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">spawn</span><span class="p">(</span>
</span><span class='line'>                    <span class="p">(</span><span class="n">ACE_THR_FUNC</span><span class="p">)</span> <span class="n">event_loop</span><span class="p">,</span> <span class="n">reactors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
</span><span class='line'>                    <span class="n">THR_NEW_LWP</span> <span class="o">|</span> <span class="n">THR_JOINABLE</span> <span class="o">|</span> <span class="n">THR_INHERIT_SCHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tid</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">current_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">/// 以简单循环方式返回 Reactor</span>
</span><span class='line'>    <span class="n">ACE_Reactor</span><span class="o">*</span> <span class="n">reactor</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">ACE_Reactor</span><span class="o">*</span> <span class="n">r</span> <span class="o">=</span> <span class="n">reactors_</span><span class="p">[</span><span class="n">current_</span><span class="p">];</span>
</span><span class='line'>        <span class="n">current_</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">threads_</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>    <span class="n">ACE_Auto_Basic_Array_Ptr</span><span class="o">&lt;</span><span class="n">ACE_Reactor</span><span class="o">*&gt;</span> <span class="n">reactors_</span><span class="p">;</span>
</span><span class='line'>    <span class="n">ACE_Auto_Basic_Array_Ptr</span><span class="o">&lt;</span><span class="n">ACE_thread_t</span><span class="o">&gt;</span> <span class="n">tids_</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="n">threads_</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="n">current_</span><span class="p">;</span> <span class="c1">// 当前分配 Reactor 索引</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Echo Acceptor</h3>

<p>据 ACE 的 Acceptor 模式, <code>Echo_Handler</code> 继承于 <code>ACE_Svc_Handler&lt;ACE_SOCK_STREAM, ACE_NULL_SYNCH&gt;</code>，它与 ACE 教科书实现相似。</p>

<ul>
<li><code>Echo_Acceptor</code> 注册默认 Reactor ，其事件循环运行于主线程。</li>
<li>创建 <code>Echo_Handler</code> 对象时，事件循环管理器以简单循环方式分配 Reactor 给新对象。</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">class</span> <span class="nc">Echo_Acceptor</span><span class="o">:</span> <span class="k">public</span> <span class="n">ACE_Acceptor</span><span class="o">&lt;</span><span class="n">Echo_Handler</span><span class="p">,</span> <span class="n">ACE_SOCK_ACCEPTOR</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">open</span><span class="p">(</span><span class="k">const</span> <span class="n">addr_type</span><span class="o">&amp;</span> <span class="n">local_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">use_select</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reuse_addr</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">flags_</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
</span><span class='line'>        <span class="n">use_select_</span> <span class="o">=</span> <span class="n">use_select</span><span class="p">;</span>
</span><span class='line'>        <span class="n">reuse_addr_</span> <span class="o">=</span> <span class="n">reuse_addr</span><span class="p">;</span>
</span><span class='line'>        <span class="n">peer_acceptor_addr_</span> <span class="o">=</span> <span class="n">local_addr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">peer_acceptor_</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">local_addr</span><span class="p">,</span> <span class="n">reuse_addr</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">peer_acceptor_</span><span class="p">.</span><span class="n">enable</span><span class="p">(</span><span class="n">ACE_NONBLOCK</span><span class="p">);</span>
</span><span class='line'>        <span class="n">ACE_Reactor</span><span class="o">::</span><span class="n">instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">register_handler</span><span class="p">(</span>
</span><span class='line'>            <span class="k">this</span><span class="p">,</span> <span class="n">ACE_Event_Handler</span><span class="o">::</span><span class="n">ACCEPT_MASK</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">this</span><span class="o">-&gt;</span><span class="n">reactor</span><span class="p">(</span><span class="n">ACE_Reactor</span><span class="o">::</span><span class="n">instance</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 按逻辑CPU数初始化事件循环（线程）数。</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">loops_</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">reactor_type</span><span class="p">,</span> <span class="n">ACE_OS</span><span class="o">::</span><span class="n">num_processors</span><span class="p">())</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">make_svc_handler</span><span class="p">(</span><span class="n">handler_type</span><span class="o">*&amp;</span> <span class="n">sh</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sh</span><span class="p">)</span>
</span><span class='line'>            <span class="n">ACE_NEW_RETURN</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">handler_type</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 事件循环管理器给 Echo_Handler 对象分配事件循环。</span>
</span><span class='line'>        <span class="n">sh</span><span class="o">-&gt;</span><span class="n">reactor</span><span class="p">(</span><span class="n">loops_</span><span class="p">.</span><span class="n">reactor</span><span class="p">());</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>    <span class="n">Event_Loop_Manager</span> <span class="n">loops_</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h2>存在问题</h2>

<ul>
<li>因 <code>ACE_Reactor::size</code> 实现<a href="https://github.com/DOCGroup/ACE_TAO/issues/855#issuecomment-612391823">不一致</a>，除 <code>ACE_Dev_Poll_Reactor</code> 返回当前注册的 handler 数量，其它实现返回handler表的容量。导致无法直接通过注册 handler 的数量，实现 <a href="https://en.wikipedia.org/wiki/Round-robin_scheduling">Round-Robin</a>，即均衡分配 handler</li>
<li>因 <code>ACE_Reactor</code> 无法获取当前是否等待事件（即空闲）状态，导致无法直接将 handler 分配到空闲事件循环中。</li>
</ul>


<p>解决上述问题，要么直接修改 ACE 的实现，要么在具体 handler 实现中增加状态或统计变量，两者都需用原子变量来避免加锁。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/08/19/docker-remote/">安全远程访问Docker</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2019-08-19T02:40:06+00:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2019/08/19/docker-remote/#disqus_thread"
             data-disqus-identifier="http://www.malike.net.cn/blog/2019/08/19/docker-remote/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Docker服务端（<code>dockerd</code>）默认监听在Unix套接口 <code>/var/run/docker.sock</code> 。仅能本地或SSH至Docker运行的主机访问，不利于自动化开发测试。</p>

<p>若需远程访问，得配置它同时监听在TCP端口（默认2376）。</p>

<p>然而，Docker不支持用户认证。 可通过配置TLS客户端和服务端认证，规避非法客户端远程访问服务端。</p>

<h2>一、创建CA</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>openssl genrsa -out ca-key.pem 4096
</span><span class='line'>openssl req -new -x509 -days <span class="m">365</span> -key ca-key.pem -sha256 -out ca.pem
</span></code></pre></td></tr></table></div></figure>


<p>交互式输入各种选项，其中</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Common Name <span class="o">(</span>e.g. server FQDN or YOUR name<span class="o">)</span> <span class="o">[]</span>: &lt;HOST&gt;
</span></code></pre></td></tr></table></div></figure>


<p><code>&lt;HOST&gt;</code> 为Docker远程服务端域名（允许不存在的域名）。</p>

<h2>二、创建远程服务端证书</h2>

<p>创建 <code>extfile.cnf</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">subjectAltName</span> <span class="o">=</span> DNS:&lt;HOST&gt;,IP:&lt;IP&gt;,IP:127.0.0.1
</span><span class='line'><span class="nv">extendedKeyUsage</span> <span class="o">=</span> serverAuth
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>&lt;HOST&gt;</code> 与上同。</li>
<li><code>&lt;IP&gt;</code> 为Docker远程服务端IP</li>
</ul>


<p>然后：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>openssl genrsa -out server-key.pem 4096
</span><span class='line'>openssl req -subj <span class="s2">&quot;/CN=&lt;HOST&gt;&quot;</span> -sha256 -new -key server-key.pem -out server.csr
</span><span class='line'>openssl x509 -req -days <span class="m">365</span> -sha256 -in server.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out server-cert.pem -extfile extfile.cnf
</span></code></pre></td></tr></table></div></figure>


<h2>三、创建客户端证书</h2>

<p>创建 <code>extfile-client.cnf</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">extendedKeyUsage</span> <span class="o">=</span> clientAuth
</span></code></pre></td></tr></table></div></figure>


<p>然后：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>openssl genrsa -out key.pem 4096
</span><span class='line'>openssl req -subj <span class="s1">&#39;/CN=client&#39;</span> -new -key key.pem -out client.csr
</span><span class='line'>openssl x509 -req -days <span class="m">365</span> -sha256 -in client.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out cert.pem -extfile extfile-client.cnf
</span></code></pre></td></tr></table></div></figure>


<p>至此，删除中间文件，并降低相关密钥访问权限。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rm -f client.csr server.csr extfile.cnf extfile-client.cnf
</span><span class='line'>chmod <span class="m">0400</span> ca-key.pem key.pem server-key.pem
</span><span class='line'>chmod <span class="m">0444</span> ca.pem server-cert.pem cert.pem
</span></code></pre></td></tr></table></div></figure>


<h2>四、远程复制服务端相关证书</h2>

<p>通过<code>scp</code>，将 <code>ca.pem</code>, <code>server-cert.pem</code> 和 <code>server-key.pem</code> 复制至远程服务端 <code>/etc/docker</code> 目录中。</p>

<p>注：<code>ca-key.pem</code> 不应复制至远程服务端。因既不意义，又增大泄漏可能性。</p>

<h2>五、编辑远程服务端 <code>/etc/docker/daemon.json</code></h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;hosts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;unix:///var/run/docker.sock&quot;</span><span class="p">,</span> <span class="s2">&quot;tcp://0.0.0.0:2376&quot;</span><span class="p">],</span>
</span><span class='line'>    <span class="nt">&quot;tls&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;tlscacert&quot;</span><span class="p">:</span> <span class="s2">&quot;/etc/docker/ca.pem&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;tlscert&quot;</span><span class="p">:</span> <span class="s2">&quot;/etc/docker/server-cert.pem&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;tlskey&quot;</span><span class="p">:</span> <span class="s2">&quot;/etc/docker/server-key.pem&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;tlsverify&quot;</span><span class="p">:</span> <span class="kc">true</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>为保证证书和密钥安全，须</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo chown root.root /etc/docker/<span class="o">{</span>ca,server-cert,server-key<span class="o">}</span>.pem
</span><span class='line'>sudo chmod og-rwx /etc/docker/<span class="o">{</span>ca,server-cert,server-key<span class="o">}</span>.pem
</span></code></pre></td></tr></table></div></figure>


<h2>六、重启远程服务端Docker服务</h2>

<p>在 <code>/lib/systemd/system/docker.service</code> 的 <code>ExecStart</code> 中， <code>-H fd://</code> 与 <code>/etc/docker/daemon.json</code> 的 <code>hosts</code> 冲突，将导致Docker服务启动失败。</p>

<p>若在 <code>/lib/systemd/system/docker.service</code> 中直接删除 <code>-H fd://</code> ，docker-ce包升级将恢复原样。</p>

<p>可创建 <code>/etc/systemd/system/docker.service.d/options.conf</code> 及其父目录，并编辑</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="k">[Service]</span>
</span><span class='line'><span class="na">ExecStart</span><span class="o">=</span>
</span><span class='line'><span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/bin/dockerd --containerd=/run/containerd/containerd.sock</span>
</span></code></pre></td></tr></table></div></figure>


<p>或执行如下命令：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo mkdir -p /etc/systemd/system/docker.service.d
</span><span class='line'>sed -n <span class="s1">&#39;/\[Service\]/ {</span>
</span><span class='line'><span class="s1">    a \</span>
</span><span class='line'><span class="s1">ExecStart=</span>
</span><span class='line'><span class="s1">    p</span>
</span><span class='line'><span class="s1">}</span>
</span><span class='line'>
</span><span class='line'><span class="s1">/ExecStart=.*/ {</span>
</span><span class='line'><span class="s1">    s/-H fd:\/\/ //p</span>
</span><span class='line'><span class="s1">}&#39;</span> /lib/systemd/system/docker.service <span class="p">|</span> sudo tee /etc/systemd/system/docker.service.d/options.conf
</span></code></pre></td></tr></table></div></figure>


<p>然后：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo systemctl daemon-reload
</span><span class='line'>sudo systemctl restart docker
</span></code></pre></td></tr></table></div></figure>


<h2>七、配置客户端</h2>

<p>在客户端和CA相关证书和密钥所在目录，创建<code>docker.env</code> ：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">DOCKER_HOST</span><span class="o">=</span>&lt;HOST&gt;:2376
</span><span class='line'><span class="nb">export </span><span class="nv">DOCKER_TLS_VERIFY</span><span class="o">=</span>1
</span><span class='line'><span class="nb">export </span><span class="nv">DOCKER_CERT_PATH</span><span class="o">=</span><span class="sb">`</span>realpath <span class="se">\`</span>dirname <span class="nv">$0</span><span class="se">\`</span><span class="sb">`</span>
</span></code></pre></td></tr></table></div></figure>


<p>在远程访问Docker前，载入该文件：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">source</span> &lt;dir&gt;/docker.env
</span></code></pre></td></tr></table></div></figure>


<p>然后，控制远程Docker与本地Docker类似，如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker images
</span></code></pre></td></tr></table></div></figure>


<h2>参考</h2>

<ul>
<li><a href="https://docs.docker.com/engine/security/https/">Protect the Docker daemon socket</a></li>
<li><a href="https://gist.github.com/kekru/974e40bb1cd4b947a53cca5ba4b0bbe5">Enable Docker Remote API with TLS client verification</a></li>
<li><a href="https://tech.paulcz.net/blog/secure-docker-with-tls/">Securing Docker with TLS certificates</a></li>
<li><a href="https://nickjanetakis.com/blog/docker-tip-73-connecting-to-a-remote-docker-daemon">Docker Tip #73: Connecting to a Remote Docker Daemon</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/08/17/rbenv-tutorial/">rbenv简介——Debian/Ubuntu中管理多版本Ruby</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2019-08-17T16:40:54+00:00" pubdate data-updated="true"></time>
        
           | <a href="/blog/2019/08/17/rbenv-tutorial/#disqus_thread"
             data-disqus-identifier="http://www.malike.net.cn/blog/2019/08/17/rbenv-tutorial/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>一、安装</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git clone git://github.com/rbenv/rbenv.git ~/.rbenv
</span><span class='line'>git clone git://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build
</span></code></pre></td></tr></table></div></figure>


<p>在国内，为了加速下述安装：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git clone https://github.com/andorchen/rbenv-taobao-mirror.git ~/.rbenv/plugins/rbenv-taobao-mirror
</span></code></pre></td></tr></table></div></figure>


<p>激活rbenv</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">eval</span> <span class="s2">&quot;$(~/.rbenv/bin/rbenv init)&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>为了每次登录后自动激活rbenv，需将<code>NMV_DIR</code>、<code>nvm.sh</code>和补齐加入bash的~/.bashrc（或zsh的~/.zshrc）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>~/.rbenv/shims:~/.rbenv/bin:<span class="nv">$PATH</span>
</span><span class='line'><span class="nb">eval</span> <span class="s2">&quot;$(rbenv init -)&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>验证是否安装正确：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -fsSL https://github.com/rbenv/rbenv-installer/raw/master/bin/rbenv-doctor <span class="p">|</span> bash
</span></code></pre></td></tr></table></div></figure>


<p>或</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>wget -qO- https://github.com/rbenv/rbenv-installer/raw/master/bin/rbenv-doctor <span class="p">|</span> bash
</span></code></pre></td></tr></table></div></figure>


<p>输出类似：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Checking <span class="k">for</span> <span class="sb">`</span>rbenv<span class="s1">&#39; in PATH: /root/.rbenv/bin/rbenv</span>
</span><span class='line'><span class="s1">Checking for rbenv shims in PATH: OK</span>
</span><span class='line'><span class="s1">Checking `rbenv install&#39;</span> support: /root/.rbenv/plugins/ruby-build/bin/rbenv-install <span class="o">(</span>ruby-build 20190615-9-gf3f4193<span class="o">)</span>
</span><span class='line'>Counting installed Ruby versions: none
</span><span class='line'>  There aren<span class="s1">&#39;t any Ruby versions installed under `/root/.rbenv/versions&#39;</span>.
</span><span class='line'>  You can install Ruby versions like so: rbenv install 2.2.4
</span><span class='line'>Checking RubyGems settings: OK
</span><span class='line'>Auditing installed plugins: OK
</span></code></pre></td></tr></table></div></figure>


<h2>二、常用命令</h2>

<h3>列表可安装的Ruby版本</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rbenv install -l
</span></code></pre></td></tr></table></div></figure>


<p>除了Ruby官方版本，还支持RBX和JRuby等。</p>

<h3>安装指定版本的Ruby</h3>

<p>安装过程，实际为下载并编译指定版本的Ruby源码，故需系统安装：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get install -y make gcc libssl-dev libreadline-dev zlib1g-dev
</span></code></pre></td></tr></table></div></figure>


<p>然后：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rbenv install 2.6.3
</span></code></pre></td></tr></table></div></figure>


<p>Ruby版本安装在 <code>~/.rbenv/versions</code> 目录中。</p>

<h3>卸载指定版本的Ruby</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rbenv uninstall 2.6.3
</span></code></pre></td></tr></table></div></figure>


<h3>设置shell的Ruby版本</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rbenv shell 2.6.3
</span></code></pre></td></tr></table></div></figure>


<p>等同于</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">RBENV_VERSION</span><span class="o">=</span>2.6.3
</span></code></pre></td></tr></table></div></figure>


<p>清除<code>RBENV_VERSION</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rbenv shell --unset
</span></code></pre></td></tr></table></div></figure>


<h2>三、升级</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> ~/.rbenv
</span><span class='line'>git pull
</span><span class='line'><span class="nb">cd</span> ~/.rbenv/plugins/ruby-build
</span><span class='line'>git pull
</span><span class='line'><span class="nb">cd</span> ~/.rbenv/plugins/rbenv-taobao-mirror
</span><span class='line'>git pull
</span></code></pre></td></tr></table></div></figure>


<h2>四、配置Systemd脚本</h2>

<p>若Ruby程序须通过Systemd启动，则其Systemd脚本类似：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="err">...</span>
</span><span class='line'>
</span><span class='line'><span class="k">[Service]</span>
</span><span class='line'><span class="err">...</span>
</span><span class='line'><span class="na">User</span><span class="o">=</span><span class="s">&lt;username&gt;</span>
</span><span class='line'><span class="na">Group</span><span class="o">=</span><span class="s">&lt;group&gt;</span>
</span><span class='line'><span class="na">Environment</span><span class="o">=</span><span class="s">&quot;PATH=/home/&lt;username&gt;/.rbenv/shims:/home/&lt;username&gt;/.rbenv/bin:/sbin:/usr/sbin:/bin:/usr/bin&quot;</span>
</span><span class='line'><span class="na">Environment</span><span class="o">=</span><span class="s">&quot;RBENV_ROOT=/home/&lt;username&gt;/.rbenv&quot;</span>
</span><span class='line'><span class="na">Environment</span><span class="o">=</span><span class="s">&quot;RBENV_VERSION=&lt;ruby version&gt;&quot;</span>
</span><span class='line'><span class="na">WorkingDirectory</span><span class="o">=</span><span class="s">&lt;app dir&gt;</span>
</span><span class='line'><span class="na">ExecStart</span><span class="o">=</span><span class="s">&lt;app dir&gt;/&lt;app&gt;</span>
</span><span class='line'><span class="err">...</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>username</code> 为服务运行的用户名，通常为 <code>RBENV_ROOT</code> 所属用户。</li>
<li><code>group</code> 为服务运行的组名，通常为 <code>RBENV_ROOT</code> 所属组。</li>
<li><code>RBENV_VERSION</code> 为Ruby版本号。</li>
<li><code>app dir</code> 为Ruby程序的目录。</li>
<li><code>app</code> 为Ruby程序或启动脚本。</li>
</ul>


<h2>五、制作Docker镜像</h2>

<p>若不希望使用Ruby的官方Docker镜像，可利用rbenv创建镜像：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='Dockerfile'><span class='line'><span class="k">FROM</span> ubuntu:bionic
</span><span class='line'><span class="k">MAINTAINER</span> ...
</span><span class='line'>
</span><span class='line'><span class="k">ENV</span> DEBIAN_FRONTEND noninteractive
</span><span class='line'><span class="k">ENV</span> RBENV_ROOT /root/.rbenv
</span><span class='line'><span class="k">ENV</span> RBENV_VERSION 2.6.3
</span><span class='line'><span class="k">ENV</span> PATH <span class="nv">$RBENV_ROOT</span>/shims:<span class="nv">$RBENV_ROOT</span>/bin:<span class="nv">$PATH</span>
</span><span class='line'><span class="k">ENV</span> RUBY_CFLAGS -O3
</span><span class='line'>
</span><span class='line'><span class="k">RUN</span> <span class="nb">set</span> -eux<span class="p">;</span> <span class="err">\</span>
</span><span class='line'>    apt-get update<span class="p">;</span> <span class="err">\</span>
</span><span class='line'>    <span class="nv">savedAptMark</span><span class="o">=</span><span class="s2">&quot;$(apt-mark showmanual)&quot;</span><span class="p">;</span> <span class="err">\</span>
</span><span class='line'>    apt-get install -y git wget make gcc libssl-dev libreadline-dev zlib1g-dev<span class="p">;</span> <span class="err">\</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;gem: --no-rdoc --no-ri&quot;</span> &gt; ~/.gemrc<span class="p">;</span> <span class="err">\</span>
</span><span class='line'>    git clone --depth <span class="m">1</span> https://github.com/rbenv/rbenv.git <span class="nv">$RBENV_ROOT</span><span class="p">;</span> <span class="err">\</span>
</span><span class='line'>    git clone --depth <span class="m">1</span> https://github.com/rbenv/ruby-build.git <span class="nv">$RBENV_ROOT</span>/plugins/ruby-build<span class="p">;</span> <span class="err">\</span>
</span><span class='line'>    git clone --depth <span class="m">1</span> https://github.com/andorchen/rbenv-taobao-mirror.git <span class="nv">$RBENV_ROOT</span>/plugins/rbenv-taobao-mirror<span class="p">;</span> <span class="err">\</span>
</span><span class='line'>    <span class="nv">CONFIGURE_OPTS</span><span class="o">=</span><span class="s2">&quot;--disable-install-doc&quot;</span> <span class="nv">MAKE_OPTS</span><span class="o">=</span><span class="s2">&quot;-j`grep -c &#39;^processor&#39; /proc/cpuinfo`&quot;</span> rbenv install <span class="nv">$RBENV_VERSION</span><span class="p">;</span> <span class="err">\</span>
</span><span class='line'>    gem sources --add https://gems.ruby-china.com/ --remove https://rubygems.com/<span class="p">;</span> <span class="err">\</span>
</span><span class='line'>    gem install bundler<span class="p">;</span> <span class="err">\</span>
</span><span class='line'>    bundle config mirror.https://rubygems.com https://gems.ruby-china.com<span class="p">;</span> <span class="err">\</span>
</span><span class='line'>    apt-mark auto <span class="s1">&#39;.*&#39;</span> &gt; /dev/null<span class="p">;</span> <span class="err">\</span>
</span><span class='line'>    <span class="o">[</span> -z <span class="s2">&quot;$savedAptMark&quot;</span> <span class="o">]</span> <span class="o">||</span> apt-mark manual <span class="nv">$savedAptMark</span><span class="p">;</span> <span class="err">\</span>
</span><span class='line'>    apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant<span class="o">=</span><span class="nb">false</span><span class="p">;</span> <span class="err">\</span>
</span><span class='line'>    apt-get clean<span class="p">;</span> <span class="err">\</span>
</span><span class='line'>    rm -rf /var/lib/apt/lists /var/tmp/* /tmp/* <span class="nv">$RBENV_ROOT</span>/versions/*/lib/ruby/gems/*/cache/*.gem
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>在国内，为了加速安装gem，上述gem和bundle设置国内镜像</li>
<li><code>RUBY_CFLAGS</code> 为 <code>-O3</code> 可编译优化的Ruby程序。在某些情况，可提高应用20-30%的运行效率。</li>
<li>可针对指定C扩展（如ffi），设置编译优化标志：</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='Dockerfile'><span class='line'>bundle config build.ffi --with-cflags<span class="o">=</span><span class="s2">&quot;$RUBY_CFLAGS&quot;</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2021/12/03/std-forward-list-tutorial/">Std::forward_list 简介</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/08/15/modify-elf-by-lief/">通过 LIEF 修改 ELF 解决 Glibc 兼容性问题</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/06/04/centos-8-lxc/">CentOS 8 上安装 LXC</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/03/15/fail2ban-tutorial-1/">Fail2Ban 简介 （一）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/07/19/import-ubuntu-duplciate-root-vg/">如何导入 Ubuntu 重复 Root 卷组</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/likema">@likema</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'likema',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/blog/categories/ace'>ace (1)</a></li><li><a href='/blog/categories/actor'>actor (3)</a></li><li><a href='/blog/categories/c'>c (2)</a></li><li><a href='/blog/categories/c-plus-plus'>c++ (4)</a></li><li><a href='/blog/categories/centos'>centos (1)</a></li><li><a href='/blog/categories/debian'>debian (7)</a></li><li><a href='/blog/categories/dnsmasq'>dnsmasq (1)</a></li><li><a href='/blog/categories/docker'>docker (2)</a></li><li><a href='/blog/categories/elf'>elf (1)</a></li><li><a href='/blog/categories/fail2ban'>fail2ban (1)</a></li><li><a href='/blog/categories/gevent'>gevent (1)</a></li><li><a href='/blog/categories/git'>git (2)</a></li><li><a href='/blog/categories/glibc'>glibc (1)</a></li><li><a href='/blog/categories/glusterfs'>glusterfs (1)</a></li><li><a href='/blog/categories/haproxy'>haproxy (1)</a></li><li><a href='/blog/categories/lief'>lief (1)</a></li><li><a href='/blog/categories/linux'>linux (18)</a></li><li><a href='/blog/categories/lua'>lua (1)</a></li><li><a href='/blog/categories/lvm'>lvm (1)</a></li><li><a href='/blog/categories/lxc'>lxc (2)</a></li><li><a href='/blog/categories/lxd'>lxd (1)</a></li><li><a href='/blog/categories/mpc'>mpc (1)</a></li><li><a href='/blog/categories/nginx'>nginx (1)</a></li><li><a href='/blog/categories/nodejs'>nodejs (1)</a></li><li><a href='/blog/categories/proxy'>proxy (5)</a></li><li><a href='/blog/categories/python'>python (9)</a></li><li><a href='/blog/categories/redhat'>redhat (1)</a></li><li><a href='/blog/categories/ruby'>ruby (1)</a></li><li><a href='/blog/categories/snap'>snap (2)</a></li><li><a href='/blog/categories/ssh'>ssh (5)</a></li><li><a href='/blog/categories/ubuntu'>ubuntu (13)</a></li><li><a href='/blog/categories/virtualbox'>virtualbox (1)</a></li><li><a href='/blog/categories/windows'>windows (1)</a></li></ul>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2021 - Like Ma -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'likeworld';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
